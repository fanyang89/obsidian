#kworker #Linux #oracle

[Oracle VM开启异步IO后OS的kworker进程异常增多](https://cs.smartx.com/cases/detail?id=1133504)

## 磁盘读写测试

```sql
CREATE TABLE test_io_table (
    id         NUMBER PRIMARY KEY,
    data       VARCHAR2(4000),
    created    DATE DEFAULT SYSDATE
);

SET SERVEROUTPUT ON
SET TIMING ON

DECLARE
   -- 测试参数（可调整）
   v_block_size     NUMBER := 8192;          -- 每个块大小（字节）
   v_total_size_mb  NUMBER := 10000;           -- 测试数据总量 (MB)
   v_blocks_per_mb  NUMBER := FLOOR(1024*1024 / v_block_size); -- 每MB需要多少块（向下取整）
   v_total_rows     NUMBER := v_total_size_mb * v_blocks_per_mb; -- 总记录数（整数）
   v_chunk_size     NUMBER := 1000;          -- 每次提交行数
   v_start_time     NUMBER;
   v_end_time       NUMBER;
   v_elapsed_time   NUMBER;
   v_mb_per_sec     NUMBER;

   -- 随机读写使用的变量（不要用 %TYPE 指向在运行时才创建的表）
   v_random_id      NUMBER;
   v_dummy_data     VARCHAR2(4000);

BEGIN
   DBMS_OUTPUT.PUT_LINE('=== Oracle 磁盘 I/O 性能测试开始 ===');
   DBMS_OUTPUT.PUT_LINE('测试数据量 (估算): ' || v_total_size_mb || ' MB');
   DBMS_OUTPUT.PUT_LINE('估算总记录数: ' || v_total_rows);
   DBMS_OUTPUT.PUT_LINE('----------------------------------------');

   -- 测试1: 顺序写入
   DBMS_OUTPUT.PUT_LINE('2. 开始顺序写入测试...');
   v_start_time := DBMS_UTILITY.GET_TIME;

   FOR i IN 1..v_total_rows LOOP
      INSERT INTO test_io_table (id, data)
      VALUES (i, RPAD('X', 4000, 'X'));

      IF MOD(i, v_chunk_size) = 0 THEN
         COMMIT;
      END IF;
   END LOOP;

   COMMIT;
   v_end_time := DBMS_UTILITY.GET_TIME;
   v_elapsed_time := (v_end_time - v_start_time) / 100; -- 转为秒
   IF v_elapsed_time > 0 THEN
      v_mb_per_sec := ROUND(v_total_size_mb / v_elapsed_time, 2);
   ELSE
      v_mb_per_sec := NULL;
   END IF;

   DBMS_OUTPUT.PUT_LINE('   顺序写入完成 - 耗时: ' || NVL(TO_CHAR(ROUND(v_elapsed_time,2)),'N/A') || ' 秒');
   DBMS_OUTPUT.PUT_LINE('   顺序写入速度(估算): ' || NVL(TO_CHAR(v_mb_per_sec),'N/A') || ' MB/秒');

   -- 测试2: 顺序读取
   DBMS_OUTPUT.PUT_LINE('3. 开始顺序读取测试...');
   v_start_time := DBMS_UTILITY.GET_TIME;

   FOR rec IN (SELECT id FROM test_io_table ORDER BY id) LOOP
      NULL; -- 模拟处理
   END LOOP;

   v_end_time := DBMS_UTILITY.GET_TIME;
   v_elapsed_time := (v_end_time - v_start_time) / 100;
   IF v_elapsed_time > 0 THEN
      v_mb_per_sec := ROUND(v_total_size_mb / v_elapsed_time, 2);
   ELSE
      v_mb_per_sec := NULL;
   END IF;

   DBMS_OUTPUT.PUT_LINE('   顺序读取完成 - 耗时: ' || NVL(TO_CHAR(ROUND(v_elapsed_time,2)),'N/A') || ' 秒');
   DBMS_OUTPUT.PUT_LINE('   顺序读取速度(估算): ' || NVL(TO_CHAR(v_mb_per_sec),'N/A') || ' MB/秒');

   -- 测试3: 随机写入（更新 10% 的行）
   DBMS_OUTPUT.PUT_LINE('4. 开始随机写入测试...');
   v_start_time := DBMS_UTILITY.GET_TIME;

   FOR i IN 1..FLOOR(v_total_rows/10) LOOP
      v_random_id := TRUNC(DBMS_RANDOM.VALUE(1, v_total_rows + 1)); -- 1..v_total_rows
      UPDATE test_io_table
         SET data = RPAD('Y', 4000, 'Y'),
             created = SYSDATE
       WHERE id = v_random_id;

      IF MOD(i, v_chunk_size) = 0 THEN
         COMMIT;
      END IF;
   END LOOP;

   COMMIT;
   v_end_time := DBMS_UTILITY.GET_TIME;
   v_elapsed_time := (v_end_time - v_start_time) / 100;
   IF v_elapsed_time > 0 THEN
      v_mb_per_sec := ROUND((v_total_size_mb/10) / v_elapsed_time, 2);
   ELSE
      v_mb_per_sec := NULL;
   END IF;

   DBMS_OUTPUT.PUT_LINE('   随机写入完成 - 耗时: ' || NVL(TO_CHAR(ROUND(v_elapsed_time,2)),'N/A') || ' 秒');
   DBMS_OUTPUT.PUT_LINE('   随机写入速度(估算): ' || NVL(TO_CHAR(v_mb_per_sec),'N/A') || ' MB/秒');

   -- 测试4: 随机读取（读取 10% 的行）
   DBMS_OUTPUT.PUT_LINE('5. 开始随机读取测试...');
   v_start_time := DBMS_UTILITY.GET_TIME;

   FOR i IN 1..FLOOR(v_total_rows/10) LOOP
      v_random_id := TRUNC(DBMS_RANDOM.VALUE(1, v_total_rows + 1));
      BEGIN
         SELECT data INTO v_dummy_data
           FROM test_io_table
          WHERE id = v_random_id;
      EXCEPTION
         WHEN NO_DATA_FOUND THEN
            NULL; -- 理论上不应发生，但保险处理
      END;
   END LOOP;

   v_end_time := DBMS_UTILITY.GET_TIME;
   v_elapsed_time := (v_end_time - v_start_time) / 100;
   IF v_elapsed_time > 0 THEN
      v_mb_per_sec := ROUND((v_total_size_mb/10) / v_elapsed_time, 2);
   ELSE
      v_mb_per_sec := NULL;
   END IF;

   DBMS_OUTPUT.PUT_LINE('   随机读取完成 - 耗时: ' || NVL(TO_CHAR(ROUND(v_elapsed_time,2)),'N/A') || ' 秒');
   DBMS_OUTPUT.PUT_LINE('   随机读取速度(估算): ' || NVL(TO_CHAR(v_mb_per_sec),'N/A') || ' MB/秒');

   DBMS_OUTPUT.PUT_LINE('----------------------------------------');
   DBMS_OUTPUT.PUT_LINE('=== 磁盘 I/O 性能测试完成 ===');

EXCEPTION
   WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE('错误: ' || SQLERRM);
      ROLLBACK;
END;
/

drop table test_io_table;
```
