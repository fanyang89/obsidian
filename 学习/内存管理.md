#Linux #memory #mm

## x86 内存布局

![[Pasted image 20240731211111.png|600]]

## 堆（heap）栈（stack）

- 每次在进程向内核申请新的堆（heap）地址时候，其地址的值是在增大的。对应 program break
- 每次进程申请新的栈（stack）地址时，其地址值是在减少的。对应寄存器 sp（stack pointer）

## x86_64 内存布局

![[Pasted image 20240731211556.png|500]]

## brk

- 不管是 32 位系统还是 64 位系统，内核都会维护一个变量 `brk`，指向堆的顶部。
- `brk` 的位置实际上就决定了堆的大小
- Linux 系统为我们提供了两个重要的系统调用来修改堆的大小，分别是 `sbrk` 和 `mmap`

```c
#include <unistd.h>
void* sbrk(intptr_t incr);
```

`sbrk` 通过给内核的 `brk` 变量增加 `incr`，来改变堆的大小，`incr` 可以为负数。当 `incr` 为正数时，堆增大，当 `incr` 为负数时，堆减小。如果 `sbrk` 函数执行成功，那返回值就是 `brk` 的旧值；如果失败，就会返回 `-1`，同时会把 `errno` 设置为 `ENOMEM`。

## mmap

## tcmalloc

## jemalloc

## HotSpot
