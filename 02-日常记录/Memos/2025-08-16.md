## 概览

- 抱怨的时间范围
- 无 crash

## 稳定性

- 100_50
  - zbs-chunkd 无重启
- 100_51
  - zbs-metad 无重启
  - zbs-chunkd 无重启
- 100_52
  - zbs-metad 无重启
  - zbs-chunkd 无重启
- 100_53
  - zbs-chunkd 无重启
- 100_54
  - zbs-metad 无重启
  - zbs-chunkd 无重启
- 100_55
  - zbs-chunkd 无重启
- 100_56
  - zbs-chunkd 无重启
- 100_57
  - zbs-chunkd 无重启

```
-> % sysbench fileio --threads=20 --file-total-size=2G --file-test-mode=rndrw --time=60 **run**
-> % sudo bpftrace -f json vfs-raw.bt -p $(pidof sysbench) -B full -o /tmp/sysbench.ndjson
-> % go run . vfs raw --dsn /home/fanmi/tmp/sysbench/sysbench-60s.ddb --table sysbench1223 -i /home/fanmi/tmp/sysbench/sysbench-60s.ndjson
```

```
-> % duckdb sysbench-60s.ddb
DuckDB v1.3.1 (Ossivalis) 2063dda3e6
Enter ".help" for usage hints.
D SHOW TABLES;
┌──────────────┐
│     name     │
│   varchar    │
├──────────────┤
│ sysbench1223 │
└──────────────┘

D SELECT * FROM sysbench1223;
┌──────────────┬──────────────────────────┬────────┬───────┬───────────────┬────────┬──────────┬────────┐
│      Ts      │          Probe           │  Tid   │  RC   │     Path      │ Inode  │  Offset  │ Length │
│    uint64    │         varchar          │ uint64 │ int64 │    varchar    │ uint64 │  uint64  │ uint64 │
├──────────────┼──────────────────────────┼────────┼───────┼───────────────┼────────┼──────────┼────────┤
│ 456585377570 │ fentry:vmlinux:vfs_write │  34213 │     0 │ test_file.2   │      0 │  8929280 │  16384 │
│ 456585378432 │ fentry:vmlinux:vfs_write │  34209 │     0 │ test_file.78  │      0 │  1900544 │  16384 │
│ 456585378121 │ fentry:vmlinux:vfs_write │  34201 │     0 │ test_file.46  │      0 │   573440 │  16384 │
│ 456585377851 │ fentry:vmlinux:vfs_write │  34205 │     0 │ test_file.30  │      0 │ 15564800 │  16384 │
│ 456585378131 │ fentry:vmlinux:vfs_write │  34204 │     0 │ test_file.80  │      0 │  6602752 │  16384 │
│ 456585378121 │ fentry:vmlinux:vfs_write │  34196 │     0 │ test_file.6   │      0 │ 16433152 │  16384 │
│ 456585378532 │ fentry:vmlinux:vfs_write │  34207 │     0 │ test_file.62  │      0 │ 12288000 │  16384 │
│ 456585378582 │ fentry:vmlinux:vfs_write │  34210 │     0 │ test_file.29  │      0 │ 10371072 │  16384 │
│ 456585379023 │ fentry:vmlinux:vfs_write │  34200 │     0 │ test_file.107 │      0 │  6275072 │  16384 │
│ 456585379745 │ fentry:vmlinux:vfs_write │  34203 │     0 │ test_file.75  │      0 │ 16711680 │  16384 │
│ 456585379905 │ fentry:vmlinux:vfs_write │  34197 │     0 │ test_file.12  │      0 │ 15794176 │  16384 │
│ 456585389763 │ fexit:vmlinux:vfs_write  │  34213 │ 16384 │               │      0 │        0 │      0 │
│ 456585390565 │ fentry:vmlinux:vfs_write │  34213 │     0 │ test_file.7   │      0 │  6651904 │  16384 │
...


```

```
-> % sudo bpftrace -p $(pidof sysbench) /usr/share/bpftrace/tools/biolatency.bt
Attaching 5 probes...
Tracing block device I/O... Hit Ctrl-C to end.

@usecs:
[2, 4)                 1 |                                                    |
[4, 8)              8675 |@@@                                                 |
[8, 16)            12693 |@@@@                                                |
[16, 32)            8466 |@@@                                                 |
[32, 64)           35160 |@@@@@@@@@@@@                                        |
[64, 128)          65745 |@@@@@@@@@@@@@@@@@@@@@@@@                            |
[128, 256)        140917 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|
[256, 512)         57535 |@@@@@@@@@@@@@@@@@@@@@                               |
[512, 1K)          10827 |@@@                                                 |
[1K, 2K)            3711 |@                                                   |
[2K, 4K)             492 |                                                    |
[4K, 8K)               0 |                                                    |
[8K, 16K)            332 |                                                    |
[16K, 32K)          1010 |                                                    |

~140ms
[128, 256)        140917 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|
```

```
-> % sudo bpftrace -p $(pidof sysbench) ./syscall-overview.bt
[sudo] password for fanmi:
Attaching 362 probes...
^C

@syscalls[tracepoint:syscalls:sys_enter_alarm]: 1
@syscalls[tracepoint:syscalls:sys_enter_unlink]: 1
@syscalls[tracepoint:syscalls:sys_enter_setrlimit]: 2
@syscalls[tracepoint:syscalls:sys_enter_getrlimit]: 2
@syscalls[tracepoint:syscalls:sys_enter_setpriority]: 2
@syscalls[tracepoint:syscalls:sys_enter_umask]: 2
@syscalls[tracepoint:syscalls:sys_enter_setpgid]: 3
@syscalls[tracepoint:syscalls:sys_enter_times]: 3
@syscalls[tracepoint:syscalls:sys_enter_epoll_pwait2]: 4
@syscalls[tracepoint:syscalls:sys_enter_flock]: 4
@syscalls[tracepoint:syscalls:sys_enter_clock_gettime]: 4
@syscalls[tracepoint:syscalls:sys_enter_inotify_add_watch]: 6
@syscalls[tracepoint:syscalls:sys_enter_readlink]: 6
@syscalls[tracepoint:syscalls:sys_enter_lgetxattr]: 6
@syscalls[tracepoint:syscalls:sys_enter_ftruncate]: 7
@syscalls[tracepoint:syscalls:sys_enter_io_uring_enter]: 9
@syscalls[tracepoint:syscalls:sys_enter_getresgid]: 12
@syscalls[tracepoint:syscalls:sys_enter_getresuid]: 12
@syscalls[tracepoint:syscalls:sys_enter_getpgrp]: 12
@syscalls[tracepoint:syscalls:sys_enter_getpeername]: 14
@syscalls[tracepoint:syscalls:sys_enter_fchdir]: 16
@syscalls[tracepoint:syscalls:sys_enter_accept]: 19
@syscalls[tracepoint:syscalls:sys_enter_capset]: 20
@syscalls[tracepoint:syscalls:sys_enter_fork]: 22
@syscalls[tracepoint:syscalls:sys_enter_accept4]: 22
@syscalls[tracepoint:syscalls:sys_enter_fsmount]: 23
@syscalls[tracepoint:syscalls:sys_enter_fsopen]: 23
@syscalls[tracepoint:syscalls:sys_enter_keyctl]: 27
@syscalls[tracepoint:syscalls:sys_enter_recvmmsg]: 32
@syscalls[tracepoint:syscalls:sys_enter_pidfd_send_signal]: 32
@syscalls[tracepoint:syscalls:sys_enter_sysinfo]: 33
@syscalls[tracepoint:syscalls:sys_enter_exit]: 34
@syscalls[tracepoint:syscalls:sys_enter_setitimer]: 35
@syscalls[tracepoint:syscalls:sys_enter_renameat]: 35
@syscalls[tracepoint:syscalls:sys_enter_setgroups]: 37
@syscalls[tracepoint:syscalls:sys_enter_signalfd4]: 38
@syscalls[tracepoint:syscalls:sys_enter_unshare]: 41
@syscalls[tracepoint:syscalls:sys_enter_fchown]: 44
@syscalls[tracepoint:syscalls:sys_enter_faccessat2]: 46
@syscalls[tracepoint:syscalls:sys_enter_fstatfs]: 47
@syscalls[tracepoint:syscalls:sys_enter_eventfd2]: 47
@syscalls[tracepoint:syscalls:sys_enter_fadvise64]: 48
@syscalls[tracepoint:syscalls:sys_enter_timerfd_settime]: 49
@syscalls[tracepoint:syscalls:sys_enter_mknodat]: 58
@syscalls[tracepoint:syscalls:sys_enter_clock_nanosleep]: 60
@syscalls[tracepoint:syscalls:sys_enter_capget]: 64
@syscalls[tracepoint:syscalls:sys_enter_fsconfig]: 69
@syscalls[tracepoint:syscalls:sys_enter_newlstat]: 75
@syscalls[tracepoint:syscalls:sys_enter_dup]: 76
@syscalls[tracepoint:syscalls:sys_enter_getsockopt]: 77
@syscalls[tracepoint:syscalls:sys_enter_chdir]: 81
@syscalls[tracepoint:syscalls:sys_enter_shutdown]: 81
@syscalls[tracepoint:syscalls:sys_enter_utimensat]: 83
@syscalls[tracepoint:syscalls:sys_enter_sendmsg]: 84
@syscalls[tracepoint:syscalls:sys_enter_splice]: 85
@syscalls[tracepoint:syscalls:sys_enter_setsid]: 88
@syscalls[tracepoint:syscalls:sys_enter_epoll_create1]: 91
@syscalls[tracepoint:syscalls:sys_enter_getcwd]: 95
@syscalls[tracepoint:syscalls:sys_enter_getsockname]: 96
@syscalls[tracepoint:syscalls:sys_enter_close_range]: 96
@syscalls[tracepoint:syscalls:sys_enter_pidfd_open]: 96
@syscalls[tracepoint:syscalls:sys_enter_newuname]: 96
@syscalls[tracepoint:syscalls:sys_enter_getgid]: 99
@syscalls[tracepoint:syscalls:sys_enter_getegid]: 99
@syscalls[tracepoint:syscalls:sys_enter_select]: 104
@syscalls[tracepoint:syscalls:sys_enter_connect]: 105
@syscalls[tracepoint:syscalls:sys_enter_rt_sigsuspend]: 106
@syscalls[tracepoint:syscalls:sys_enter_bind]: 109
@syscalls[tracepoint:syscalls:sys_enter_pselect6]: 122
@syscalls[tracepoint:syscalls:sys_enter_writev]: 123
@syscalls[tracepoint:syscalls:sys_enter_perf_event_open]: 157
@syscalls[tracepoint:syscalls:sys_enter_openat2]: 160
@syscalls[tracepoint:syscalls:sys_enter_arch_prctl]: 160
@syscalls[tracepoint:syscalls:sys_enter_unlinkat]: 164
@syscalls[tracepoint:syscalls:sys_enter_dup3]: 168
@syscalls[tracepoint:syscalls:sys_enter_bpf]: 176
@syscalls[tracepoint:syscalls:sys_enter_statx]: 181
@syscalls[tracepoint:syscalls:sys_enter_socketpair]: 183
@syscalls[tracepoint:syscalls:sys_enter_getuid]: 188
@syscalls[tracepoint:syscalls:sys_enter_geteuid]: 194
@syscalls[tracepoint:syscalls:sys_enter_kill]: 200
@syscalls[tracepoint:syscalls:sys_enter_sched_getaffinity]: 202
@syscalls[tracepoint:syscalls:sys_enter_dup2]: 227
@syscalls[tracepoint:syscalls:sys_enter_setns]: 228
@syscalls[tracepoint:syscalls:sys_enter_execve]: 240
@syscalls[tracepoint:syscalls:sys_enter_statfs]: 240
@syscalls[tracepoint:syscalls:sys_enter_waitid]: 257
@syscalls[tracepoint:syscalls:sys_enter_setgid]: 257
@syscalls[tracepoint:syscalls:sys_enter_clone3]: 261
@syscalls[tracepoint:syscalls:sys_enter_setuid]: 264
@syscalls[tracepoint:syscalls:sys_enter_getrusage]: 272
@syscalls[tracepoint:syscalls:sys_enter_exit_group]: 274
@syscalls[tracepoint:syscalls:sys_enter_clone]: 284
@syscalls[tracepoint:syscalls:sys_enter_newstat]: 335
@syscalls[tracepoint:syscalls:sys_enter_set_tid_address]: 352
@syscalls[tracepoint:syscalls:sys_enter_recvmsg]: 507
@syscalls[tracepoint:syscalls:sys_enter_pipe2]: 526
@syscalls[tracepoint:syscalls:sys_enter_setsockopt]: 578
@syscalls[tracepoint:syscalls:sys_enter_brk]: 646
@syscalls[tracepoint:syscalls:sys_enter_getpriority]: 648
@syscalls[tracepoint:syscalls:sys_enter_gettid]: 653
@syscalls[tracepoint:syscalls:sys_enter_seccomp]: 684
@syscalls[tracepoint:syscalls:sys_enter_ioprio_get]: 700
@syscalls[tracepoint:syscalls:sys_enter_wait4]: 704
@syscalls[tracepoint:syscalls:sys_enter_rseq]: 723
@syscalls[tracepoint:syscalls:sys_enter_poll]: 755
@syscalls[tracepoint:syscalls:sys_enter_access]: 791
@syscalls[tracepoint:syscalls:sys_enter_sched_getscheduler]: 952
@syscalls[tracepoint:syscalls:sys_enter_set_robust_list]: 979
@syscalls[tracepoint:syscalls:sys_enter_readv]: 1002
@syscalls[tracepoint:syscalls:sys_enter_readlinkat]: 1006
@syscalls[tracepoint:syscalls:sys_enter_madvise]: 1067
@syscalls[tracepoint:syscalls:sys_enter_prlimit64]: 1092
@syscalls[tracepoint:syscalls:sys_enter_getppid]: 1256
@syscalls[tracepoint:syscalls:sys_enter_sigaltstack]: 1395
@syscalls[tracepoint:syscalls:sys_enter_mprotect]: 1449
@syscalls[tracepoint:syscalls:sys_enter_tgkill]: 1532
@syscalls[tracepoint:syscalls:sys_enter_rt_sigreturn]: 1546
@syscalls[tracepoint:syscalls:sys_enter_epoll_wait]: 1577
@syscalls[tracepoint:syscalls:sys_enter_open]: 1825
@syscalls[tracepoint:syscalls:sys_enter_ppoll]: 1827
@syscalls[tracepoint:syscalls:sys_enter_sched_yield]: 1958
@syscalls[tracepoint:syscalls:sys_enter_prctl]: 2341
@syscalls[tracepoint:syscalls:sys_enter_munmap]: 2714
@syscalls[tracepoint:syscalls:sys_enter_lseek]: 2815
@syscalls[tracepoint:syscalls:sys_enter_getrandom]: 2854
@syscalls[tracepoint:syscalls:sys_enter_getpid]: 3895
@syscalls[tracepoint:syscalls:sys_enter_newfstatat]: 5825
@syscalls[tracepoint:syscalls:sys_enter_epoll_ctl]: 6029
@syscalls[tracepoint:syscalls:sys_enter_socket]: 6597
@syscalls[tracepoint:syscalls:sys_enter_ioctl]: 6921
@syscalls[tracepoint:syscalls:sys_enter_mmap]: 7977
@syscalls[tracepoint:syscalls:sys_enter_fcntl]: 8411
@syscalls[tracepoint:syscalls:sys_enter_write]: 11221
@syscalls[tracepoint:syscalls:sys_enter_nanosleep]: 15656
@syscalls[tracepoint:syscalls:sys_enter_epoll_pwait]: 18641
@syscalls[tracepoint:syscalls:sys_enter_rt_sigaction]: 19168
@syscalls[tracepoint:syscalls:sys_enter_rt_sigprocmask]: 21410
@syscalls[tracepoint:syscalls:sys_enter_getdents64]: 27508
@syscalls[tracepoint:syscalls:sys_enter_newfstat]: 31053
@syscalls[tracepoint:syscalls:sys_enter_close]: 32483
@syscalls[tracepoint:syscalls:sys_enter_read]: 37158
@syscalls[tracepoint:syscalls:sys_enter_openat]: 39599
@syscalls[tracepoint:syscalls:sys_enter_recvfrom]: 54320
@syscalls[tracepoint:syscalls:sys_enter_sendto]: 59922
@syscalls[tracepoint:syscalls:sys_enter_pwrite64]: 81122
@syscalls[tracepoint:syscalls:sys_enter_pread64]: 123097
@syscalls[tracepoint:syscalls:sys_enter_fsync]: 262087
@syscalls[tracepoint:syscalls:sys_enter_futex]: 310360
```

```
-> % sysbench fileio --threads=20 --file-total-size=2G --file-test-mode=rndrd --time=10 run
sysbench 1.0.20 (using system LuaJIT 2.1.1720049189)

Running the test with following options:
Number of threads: 20
Initializing random number generator from current time


Extra file open flags: (none)
128 files, 16MiB each
2GiB total file size
Block size 16KiB
Number of IO requests: 0
Read/Write ratio for combined random IO test: 1.50
Periodic FSYNC enabled, calling fsync() each 100 requests.
Calling fsync() at the end of test, Enabled.
Using synchronous I/O mode
Doing random read test
Initializing worker threads...

Threads started!


File operations:
    reads/s:                      1447220.10
    writes/s:                     0.00
    fsyncs/s:                     0.00

Throughput:
    read, MiB/s:                  22612.81
    written, MiB/s:               0.00

General statistics:
    total time:                          10.0001s
    total number of events:              14473648

Latency (ms):
         min:                                    0.00
         avg:                                    0.01
         max:                                    0.86
         95th percentile:                        0.02
         sum:                               116923.34

Threads fairness:
    events (avg/stddev):           723682.4000/6270.95
    execution time (avg/stddev):   5.8462/0.06
```

```
-> % sysbench fileio --threads=20 --file-total-size=2G --file-test-mode=rndwr --time=10 run
sysbench 1.0.20 (using system LuaJIT 2.1.1720049189)

Running the test with following options:
Number of threads: 20
Initializing random number generator from current time


Extra file open flags: (none)
128 files, 16MiB each
2GiB total file size
Block size 16KiB
Number of IO requests: 0
Read/Write ratio for combined random IO test: 1.50
Periodic FSYNC enabled, calling fsync() each 100 requests.
Calling fsync() at the end of test, Enabled.
Using synchronous I/O mode
Doing random write test
Initializing worker threads...

Threads started!


File operations:
    reads/s:                      0.00
    writes/s:                     7485.47
    fsyncs/s:                     9822.23

Throughput:
    read, MiB/s:                  0.00
    written, MiB/s:               116.96

General statistics:
    total time:                          10.1391s
    total number of events:              172934

Latency (ms):
         min:                                    0.00
         avg:                                    1.16
         max:                                   53.80
         95th percentile:                        4.65
         sum:                               199948.98

Threads fairness:
    events (avg/stddev):           8646.7000/310.99
    execution time (avg/stddev):   9.9974/0.00
```

```
-> % sysbench fileio --threads=20 --file-total-size=2G --file-test-mode=rndrw --time=20 run
sysbench 1.0.20 (using system LuaJIT 2.1.1720049189)

Running the test with following options:
Number of threads: 20
Initializing random number generator from current time


Extra file open flags: (none)
128 files, 16MiB each
2GiB total file size
Block size 16KiB
Number of IO requests: 0
Read/Write ratio for combined random IO test: 1.50
Periodic FSYNC enabled, calling fsync() each 100 requests.
Calling fsync() at the end of test, Enabled.
Using synchronous I/O mode
Doing random r/w test
Initializing worker threads...

Threads started!


File operations:
    reads/s:                      7751.16
    writes/s:                     5167.52
    fsyncs/s:                     16662.00

Throughput:
    read, MiB/s:                  121.11
    written, MiB/s:               80.74

General statistics:
    total time:                          20.0170s
    total number of events:              589572

Latency (ms):
         min:                                    0.00
         avg:                                    0.68
         max:                                   51.70
         95th percentile:                        3.68
         sum:                               399802.27

Threads fairness:
    events (avg/stddev):           29478.6000/663.70
    execution time (avg/stddev):   19.9901/0.00

-> % sudo bpftrace -p $(pidof sysbench) ./fsync.bt
[sudo] password for fanmi:
Attaching 3 probes...


@fsync_hist_ns:
[128, 256)         19880 |@@@@@@@                                             |
[256, 512)        130524 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|
[512, 1K)          25259 |@@@@@@@@@@                                          |
[1K, 2K)            2182 |                                                    |
[2K, 4K)             298 |                                                    |
[4K, 8K)             173 |                                                    |
[8K, 16K)             80 |                                                    |
[16K, 32K)            11 |                                                    |
[32K, 64K)            18 |                                                    |
[64K, 128K)            0 |                                                    |
[128K, 256K)           0 |                                                    |
[256K, 512K)           0 |                                                    |
[512K, 1M)             7 |                                                    |
[1M, 2M)            1115 |                                                    |
[2M, 4M)           97316 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@              |
[4M, 8M)           15969 |@@@@@@                                              |
[8M, 16M)             44 |                                                    |
[16M, 32M)            45 |                                                    |
[32M, 64M)            35 |                                                    |

@fsync_stats: count 292956, average 1221203, total 357758960429
```

```
fanmi@fanyang-max [13:30:52] [~/tmp/sysbench]
-> % sysbench fileio --threads=20 --file-total-size=2G --file-test-mode=rndrw --time=20 run
sysbench 1.0.20 (using system LuaJIT 2.1.1720049189)

Running the test with following options:
Number of threads: 20
Initializing random number generator from current time


Extra file open flags: (none)
128 files, 16MiB each
2GiB total file size
Block size 16KiB
Number of IO requests: 0
Read/Write ratio for combined random IO test: 1.50
Periodic FSYNC enabled, calling fsync() each 100 requests.
Calling fsync() at the end of test, Enabled.
Using synchronous I/O mode
Doing random r/w test
Initializing worker threads...

Threads started!


File operations:
    reads/s:                      7063.52
    writes/s:                     4709.06
    fsyncs/s:                     15195.10

Throughput:
    read, MiB/s:                  110.37
    written, MiB/s:               73.58

General statistics:
    total time:                          20.0227s
    total number of events:              537422

Latency (ms):
         min:                                    0.00
         avg:                                    0.74
         max:                                   39.29
         95th percentile:                        4.18
         sum:                               399789.69

Threads fairness:
    events (avg/stddev):           26871.1000/637.60
    execution time (avg/stddev):   19.9895/0.00

-> % sudo bpftrace -p $(pidof sysbench) sync-io.bt
[sudo] password for fanmi:
Attaching 9 probes...

@fsync_hist_ns:
[128, 256)         15626 |@@@@@@@                                             |
[256, 512)        110898 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|
[512, 1K)          32149 |@@@@@@@@@@@@@@@                                     |
[1K, 2K)            1891 |                                                    |
[2K, 4K)             281 |                                                    |
[4K, 8K)             162 |                                                    |
[8K, 16K)             72 |                                                    |
[16K, 32K)            18 |                                                    |
[32K, 64K)             4 |                                                    |
[64K, 128K)            0 |                                                    |
[128K, 256K)           0 |                                                    |
[256K, 512K)           0 |                                                    |
[512K, 1M)            13 |                                                    |
[1M, 2M)            4193 |@                                                   |
[2M, 4M)           76730 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                 |
[4M, 8M)           25822 |@@@@@@@@@@@@                                        |
[8M, 16M)             23 |                                                    |
[16M, 32M)            80 |                                                    |
[32M, 64M)            40 |                                                    |


@fsync_stats: count 268002, average 1356393, total 363516125706

@pread64_hist_ns:
[128, 256)            81 |                                                    |
[256, 512)           161 |                                                    |
[512, 1K)            229 |                                                    |
[1K, 2K)           19022 |@@@@@@@@@@                                          |
[2K, 4K)           93429 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|
[4K, 8K)           11641 |@@@@@@                                              |
[8K, 16K)            312 |                                                    |
[16K, 32K)            35 |                                                    |
[32K, 64K)            14 |                                                    |
[64K, 128K)           15 |                                                    |
[128K, 256K)           1 |                                                    |
[256K, 512K)           1 |                                                    |


@pread64_stats: count 124941, average 2892, total 361412977

@pwrite64_hist_ns:
[512, 1K)              7 |                                                    |
[1K, 2K)              12 |                                                    |
[2K, 4K)            3947 |@@@                                                 |
[4K, 8K)           54938 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|
[8K, 16K)          20503 |@@@@@@@@@@@@@@@@@@@                                 |
[16K, 32K)          2980 |@@                                                  |
[32K, 64K)           375 |                                                    |
[64K, 128K)          107 |                                                    |
[128K, 256K)          61 |                                                    |
[256K, 512K)          45 |                                                    |
[512K, 1M)            19 |                                                    |


@pwrite64_stats: count 82994, average 8268, total 686273870
```

```
-> % sysbench fileio --threads=20 --file-total-size=2G --file-test-mode=rndrw --time=20 run
sysbench 1.0.20 (using system LuaJIT 2.1.1720049189)

Running the test with following options:
Number of threads: 20
Initializing random number generator from current time


Extra file open flags: (none)
128 files, 16MiB each
2GiB total file size
Block size 16KiB
Number of IO requests: 0
Read/Write ratio for combined random IO test: 1.50
Periodic FSYNC enabled, calling fsync() each 100 requests.
Calling fsync() at the end of test, Enabled.
Using synchronous I/O mode
Doing random r/w test
Initializing worker threads...

Threads started!


File operations:
    reads/s:                      6623.94
    writes/s:                     4415.71
    fsyncs/s:                     14253.91

Throughput:
    read, MiB/s:                  103.50
    written, MiB/s:               69.00

General statistics:
    total time:                          20.0633s
    total number of events:              504931

Latency (ms):
         min:                                    0.00
         avg:                                    0.79
         max:                                   52.65
         95th percentile:                        4.10
         sum:                               399910.16

Threads fairness:
    events (avg/stddev):           25246.5500/698.78
    execution time (avg/stddev):   19.9955/0.00

-> % sudo bpftrace -p $(pidof sysbench) sync-io-size.bt
Attaching 2 probes...


@pread_size_bytes[20]: 1
@pread_size_bytes[32]: 1
@pread_size_bytes[840]: 2
@pread_size_bytes[100]: 2
@pread_size_bytes[1024]: 2
@pread_size_bytes[4096]: 12
@pread_size_bytes[64]: 184
@pread_size_bytes[4120]: 206
@pread_size_bytes[896]: 330
@pread_size_bytes[16384]: 126004
@pwrite_size_bytes[980780]: 1
@pwrite_size_bytes[577336]: 1
@pwrite_size_bytes[118760]: 2
@pwrite_size_bytes[96]: 4
@pwrite_size_bytes[24]: 5
@pwrite_size_bytes[4096]: 5
@pwrite_size_bytes[1]: 8
@pwrite_size_bytes[16384]: 83996
```

```
fanmi@fanyang-max [14:04:25] [~/tmp/sysbench]
-> % cat /sys/block/nvme0n1/queue/scheduler
[none] mq-deadline kyber bfq

fanmi@fanyang-max [14:04:28] [~/tmp/sysbench]
-> % cat /sys/block/nvme1n1/queue/scheduler
[none] mq-deadline kyber bfq
```

检查块层延迟：

```
-> % sudo bpftrace -l 'tracepoint:nvme:*'
tracepoint:nvme:nvme_async_event
tracepoint:nvme:nvme_complete_rq
tracepoint:nvme:nvme_setup_cmd
tracepoint:nvme:nvme_sq
```

```
-> % sudo bpftrace nvme-lat.bt
Attaching 3 probes...
^CMaps cleared.

@latency_write_us:
[4, 8)               875 |                                                    |
[8, 16)             2054 |                                                    |
[16, 32)           25530 |@@@@@                                               |
[32, 64)          171114 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@             |
[64, 128)         227727 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|
[128, 256)         22875 |@@@@@                                               |
[256, 512)         12538 |@@                                                  |
[512, 1K)            864 |                                                    |
[1K, 2K)              15 |                                                    |
[2K, 4K)               3 |                                                    |
[4K, 8K)               0 |                                                    |
[8K, 16K)              1 |                                                    |
[16K, 32K)            25 |                                                    |
[32K, 64K)            10 |                                                    |
[64K, 128K)           11 |                                                    |
[128K, 256K)          22 |                                                    |
[256K, 512K)          27 |                                                    |
[512K, 1M)            12 |                                                    |
[1M, 2M)               4 |                                                    |
[2M, 4M)               2 |                                                    |
[4M, 8M)               5 |                                                    |
[8M, 16M)              1 |                                                    |
```

```
# 查看 block_rq_issue 的可用字段
cat /sys/kernel/debug/tracing/events/block/block_rq_issue/format

# 查看 block_rq_complete 的可用字段
cat /sys/kernel/debug/tracing/events/block/block_rq_complete/format
```

```
-> % sudo cat /sys/kernel/debug/tracing/events/block/block_rq_issue/format
[sudo] password for fanmi:
name: block_rq_issue
ID: 1440
format:
        field:unsigned short common_type;       offset:0;       size:2; signed:0;
        field:unsigned char common_flags;       offset:2;       size:1; signed:0;
        field:unsigned char common_preempt_count;       offset:3;       size:1; signed:0;
        field:int common_pid;   offset:4;       size:4; signed:1;

        field:dev_t dev;        offset:8;       size:4; signed:0;
        field:sector_t sector;  offset:16;      size:8; signed:0;
        field:unsigned int nr_sector;   offset:24;      size:4; signed:0;
        field:unsigned int bytes;       offset:28;      size:4; signed:0;
        field:unsigned short ioprio;    offset:32;      size:2; signed:0;
        field:char rwbs[9];     offset:34;      size:9; signed:0;
        field:char comm[16];    offset:43;      size:16;        signed:0;
        field:__data_loc char[] cmd;    offset:60;      size:4; signed:0;

print fmt: "%d,%d %s %u (%s) %llu + %u %s,%u,%u [%s]", ((unsigned int) ((REC->dev) >> 20)), ((unsigned int) ((REC->dev) & ((1U << 20) - 1))), REC->rwbs, REC->bytes, __get_str(cmd), (unsigned long long)REC->sector, REC->nr_sector, __print_symbolic((((REC->ioprio) >> 13) & (8 - 1)), { IOPRIO_CLASS_NONE, "none" }, { IOPRIO_CLASS_RT, "rt" }, { IOPRIO_CLASS_BE, "be" }, { IOPRIO_CLASS_IDLE, "idle" }, { IOPRIO_CLASS_INVALID, "invalid"}), (((REC->ioprio) >> 3) & ((1 << 10) - 1)), ((REC->ioprio) & ((1 << 3) - 1)), REC->comm

fanmi@fanyang-max [14:20:48] [~/tmp/sysbench]
-> % sudo cat /sys/kernel/debug/tracing/events/block/block_rq_complete/format
name: block_rq_complete
ID: 1443
format:
        field:unsigned short common_type;       offset:0;       size:2; signed:0;
        field:unsigned char common_flags;       offset:2;       size:1; signed:0;
        field:unsigned char common_preempt_count;       offset:3;       size:1; signed:0;
        field:int common_pid;   offset:4;       size:4; signed:1;

        field:dev_t dev;        offset:8;       size:4; signed:0;
        field:sector_t sector;  offset:16;      size:8; signed:0;
        field:unsigned int nr_sector;   offset:24;      size:4; signed:0;
        field:int error;        offset:28;      size:4; signed:1;
        field:unsigned short ioprio;    offset:32;      size:2; signed:0;
        field:char rwbs[9];     offset:34;      size:9; signed:0;
        field:__data_loc char[] cmd;    offset:44;      size:4; signed:0;

print fmt: "%d,%d %s (%s) %llu + %u %s,%u,%u [%d]", ((unsigned int) ((REC->dev) >> 20)), ((unsigned int) ((REC->dev) & ((1U << 20) - 1))), REC->rwbs, __get_str(cmd), (unsigned long long)REC->sector, REC->nr_sector, __print_symbolic((((REC->ioprio) >> 13) & (8 - 1)), { IOPRIO_CLASS_NONE, "none" }, { IOPRIO_CLASS_RT, "rt" }, { IOPRIO_CLASS_BE, "be" }, { IOPRIO_CLASS_IDLE, "idle" }, { IOPRIO_CLASS_INVALID, "invalid"}), (((REC->ioprio) >> 3) & ((1 << 10) - 1)), ((REC->ioprio) & ((1 << 3) - 1)), REC->error
```

```
-> % sudo bpftrace blk-lat.bt
Attaching 3 probes...^C

@latency_write_us:
[4, 8)               371 |                                                    |
[8, 16)             1896 |                                                    |
[16, 32)           24413 |@@@@@@@                                             |
[32, 64)          128649 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@               |
[64, 128)         176902 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|
[128, 256)         12871 |@@@                                                 |
[256, 512)         10914 |@@@                                                 |
[512, 1K)            750 |                                                    |
[1K, 2K)              16 |                                                    |
[2K, 4K)               3 |                                                    |
[4K, 8K)              14 |                                                    |
[8K, 16K)              0 |                                                    |
[16K, 32K)             6 |                                                    |
[32K, 64K)             0 |                                                    |
[64K, 128K)            0 |                                                    |
[128K, 256K)           0 |                                                    |
[256K, 512K)           0 |                                                    |
[512K, 1M)             0 |                                                    |
[1M, 2M)               0 |                                                    |
[2M, 4M)               0 |                                                    |
[4M, 8M)               0 |                                                    |
[8M, 16M)              1 |                                                    |
```

```
-> % sysbench fileio --threads=20 --file-total-size=2G --file-test-mode=rndrw --file-extra-flags=direct --file-fsync-freq=0 run
sysbench 1.0.20 (using system LuaJIT 2.1.1720049189)

Running the test with following options:
Number of threads: 20
Initializing random number generator from current time


Extra file open flags: directio
128 files, 16MiB each
2GiB total file size
Block size 16KiB
Number of IO requests: 0
Read/Write ratio for combined random IO test: 1.50
Calling fsync() at the end of test, Enabled.
Using synchronous I/O mode
Doing random r/w test
Initializing worker threads...

Threads started!


File operations:
    reads/s:                      39673.55
    writes/s:                     26450.90
    fsyncs/s:                     246.79

Throughput:
    read, MiB/s:                  619.90
    written, MiB/s:               413.30

General statistics:
    total time:                          10.3724s
    total number of events:              685911

Latency (ms):
         min:                                    0.00
         avg:                                    0.29
         max:                                   23.85
         95th percentile:                        0.73
         sum:                               199863.55

Threads fairness:
    events (avg/stddev):           34295.5500/96.56
    execution time (avg/stddev):   9.9932/0.00
```

## 如何模拟 pg

```
● PostgreSQL 中 fdatasync() 的调用频率取决于不同的场景和配置参数：

  WAL (Write-Ahead Log) 的 fdatasync() 频率

  1. WAL Writer 进程

  - 默认频率：每 200ms (wal_writer_delay = 200ms)
  - 触发条件：
    - 当有 WAL 数据需要写入时
    - 累计写入量达到 wal_writer_flush_after (默认 1MB)
  - 代码位置：src/backend/postmaster/walwriter.c:255

  2. 事务提交时

  - 同步提交：每次事务提交都会调用 fdatasync()
  - 异步提交：由 WAL Writer 进程在后续周期中处理

  3. WAL 段切换时

  - 触发条件：当一个 WAL 段文件写满时
  - 代码位置：src/backend/access/transam/xlog.c:2647

  数据文件的 fdatasync() 频率

  1. Checkpoint 进程

  - 默认频率：每 5 分钟 (checkpoint_timeout = 5min)
  - 触发条件：
    - 时间间隔达到 checkpoint_timeout
    - WAL 文件数量达到 max_wal_size 限制
  - 代码位置：src/backend/postmaster/checkpointer.c

  2. 后端进程

  - 触发条件：当 Checkpointer 队列满时，后端进程会直接执行 fdatasync()
  - 代码位置：src/backend/storage/smgr/md.c:994

  关键配置参数

  WAL 相关

  - wal_writer_delay：WAL Writer 的轮询间隔 (默认 200ms)
  - wal_writer_flush_after：WAL Writer 累计写入量阈值 (默认 1MB)
  - synchronous_commit：控制事务提交的同步级别

  Checkpoint 相关

  - checkpoint_timeout：Checkpoint 时间间隔 (默认 5min)
  - max_wal_size：触发 checkpoint 的 WAL 大小阈值 (默认 1GB)
  - checkpoint_flush_after：Checkpoint 批量写入阈值 (默认 0)

  总结

  PostgreSQL 通过多个后台进程和配置参数来平衡性能与数据安全性：

  1. WAL：频繁同步 (200ms 周期 + 事务提交时)
  2. 数据文件：低频同步 (5分钟 周期 + 批量处理)

  这种设计确保了 WAL 的高可靠性，同时避免了数据文件的频繁同步对性能的影响。
```

1M 做一次 `fdatasync()`
https://postgresqlco.nf/doc/en/param/wal_writer_flush_after/

200ms 做一次 `fdatasync()`
https://postgresqlco.nf/doc/en/param/wal_writer_delay/

https://doxygen.postgresql.org/md_src_backend_storage_aio_README.html

```
-> % sudo bpftrace -p $(pidof sysbench) ~/workspace/bpfstream/fsync-lat.bt
Attaching 4 probes...

@us_btrfs[sysbench]:
[0]                55440 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|
[1]                 1585 |@                                                   |
[2, 4)               202 |                                                    |
[4, 8)               123 |                                                    |
[8, 16)              139 |                                                    |
[16, 32)              16 |                                                    |
[32, 64)               6 |                                                    |
[64, 128)              4 |                                                    |
[128, 256)             0 |                                                    |
[256, 512)             0 |                                                    |
[512, 1K)              0 |                                                    |
[1K, 2K)               7 |                                                    |
[2K, 4K)           12534 |@@@@@@@@@@@                                         |
[4K, 8K)           23618 |@@@@@@@@@@@@@@@@@@@@@@                              |
[8K, 16K)              0 |                                                    |
[16K, 32K)            20 |                                                    |
```

```
-> % sudo bpftrace fsync-lat.bt
Attaching 6 probes...
^C

@btrfs_fsync_ns[sysbench]:
[256, 512)         48798 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|
[512, 1K)          25022 |@@@@@@@@@@@@@@@@@@@@@@@@@@                          |
[1K, 2K)            1560 |@                                                   |
[2K, 4K)             119 |                                                    |
[4K, 8K)             132 |                                                    |
[8K, 16K)             36 |                                                    |
[16K, 32K)            15 |                                                    |
[32K, 64K)             4 |                                                    |
[64K, 128K)            0 |                                                    |
[128K, 256K)           0 |                                                    |
[256K, 512K)           0 |                                                    |
[512K, 1M)             0 |                                                    |
[1M, 2M)              23 |                                                    |
[2M, 4M)           31260 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                   |
[4M, 8M)           18247 |@@@@@@@@@@@@@@@@@@@                                 |
[8M, 16M)             20 |                                                    |
[16M, 32M)            60 |                                                    |


@syscall_fsync_ns[sysbench]:
[256, 512)            13 |                                                    |
[512, 1K)          52428 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|
[1K, 2K)           22065 |@@@@@@@@@@@@@@@@@@@@@                               |
[2K, 4K)             813 |                                                    |
[4K, 8K)             194 |                                                    |
[8K, 16K)            120 |                                                    |
[16K, 32K)            34 |                                                    |
[32K, 64K)            14 |                                                    |
[64K, 128K)            2 |                                                    |
[128K, 256K)           1 |                                                    |
[256K, 512K)           2 |                                                    |
[512K, 1M)             0 |                                                    |
[1M, 2M)              23 |                                                    |
[2M, 4M)           31247 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                      |
[4M, 8M)           18260 |@@@@@@@@@@@@@@@@@@                                  |
[8M, 16M)             20 |                                                    |
[16M, 32M)            60 |                                                    |

-> % sysbench fileio --threads=20 --file-total-size=2G --file-test-mode=rndrw run
sysbench 1.0.20 (using system LuaJIT 2.1.1720049189)

Running the test with following options:
Number of threads: 20
Initializing random number generator from current time


Extra file open flags: (none)
128 files, 16MiB each
2GiB total file size
Block size 16KiB
Number of IO requests: 0
Read/Write ratio for combined random IO test: 1.50
Periodic FSYNC enabled, calling fsync() each 100 requests.
Calling fsync() at the end of test, Enabled.
Using synchronous I/O mode
Doing random r/w test
Initializing worker threads...

Threads started!


File operations:
    reads/s:                      5744.74
    writes/s:                     3829.83
    fsyncs/s:                     12509.45

Throughput:
    read, MiB/s:                  89.76
    written, MiB/s:               59.84

General statistics:
    total time:                          10.0153s
    total number of events:              218636

Latency (ms):
         min:                                    0.00
         avg:                                    0.91
         max:                                   30.24
         95th percentile:                        4.49
         sum:                               199909.31

Threads fairness:
    events (avg/stddev):           10931.8000/412.03
    execution time (avg/stddev):   9.9955/0.00
```

![[Pasted image 20250816230137.png]]
https://www.techpowerup.com/forums/threads/sysbench-file-io-benchmark.322816/
https://shoppon.github.io/linux/sysbench.html

![[Pasted image 20250816230354.png]]

```
fanmi@fanyang-epyc [23:13:03] [/mnt/sysbench]
-> % sysbench fileio --threads=20 --file-total-size=2G --file-test-mode=rndrw run
sysbench 1.0.20 (using system LuaJIT 2.1.1720049189)

Running the test with following options:
Number of threads: 20
Initializing random number generator from current time


Extra file open flags: (none)
128 files, 16MiB each
2GiB total file size
Block size 16KiB
Number of IO requests: 0
Read/Write ratio for combined random IO test: 1.50
Periodic FSYNC enabled, calling fsync() each 100 requests.
Calling fsync() at the end of test, Enabled.
Using synchronous I/O mode
Doing random r/w test
Initializing worker threads...

Threads started!


File operations:
    reads/s:                      1658.43
    writes/s:                     1105.62
    fsyncs/s:                     3772.44

Throughput:
    read, MiB/s:                  25.91
    written, MiB/s:               17.28

General statistics:
    total time:                          10.4173s
    total number of events:              65547

Latency (ms):
         min:                                    0.00
         avg:                                    3.05
         max:                                   41.38
         95th percentile:                        7.30
         sum:                               199977.05

Threads fairness:
    events (avg/stddev):           3277.3500/525.01
    execution time (avg/stddev):   9.9989/0.00


fanmi@fanyang-epyc [23:13:18] [/mnt/sysbench]
-> % sysbench fileio --threads=20 --file-total-size=2G --file-test-mode=rndrw --file-extra-flags=direct --file-fsync-freq=0 run
sysbench 1.0.20 (using system LuaJIT 2.1.1720049189)

Running the test with following options:
Number of threads: 20
Initializing random number generator from current time


Extra file open flags: directio
128 files, 16MiB each
2GiB total file size
Block size 16KiB
Number of IO requests: 0
Read/Write ratio for combined random IO test: 1.50
Calling fsync() at the end of test, Enabled.
Using synchronous I/O mode
Doing random r/w test
Initializing worker threads...

Threads started!


File operations:
    reads/s:                      75843.29
    writes/s:                     50561.11
    fsyncs/s:                     244.32

Throughput:
    read, MiB/s:                  1185.05
    written, MiB/s:               790.02

General statistics:
    total time:                          10.4762s
    total number of events:              1324497

Latency (ms):
         min:                                    0.02
         avg:                                    0.15
         max:                                   30.88
         95th percentile:                        0.36
         sum:                               199106.80

Threads fairness:
    events (avg/stddev):           66224.8500/536.77
    execution time (avg/stddev):   9.9553/0.00
```

```
fanmi@fanyang-epyc [23:19:48] [/tmp]
-> % sysbench fileio --threads=20 --file-total-size=2G --file-test-mode=rndrw run
sysbench 1.0.20 (using system LuaJIT 2.1.1720049189)

Running the test with following options:
Number of threads: 20
Initializing random number generator from current time


Extra file open flags: (none)
128 files, 16MiB each
2GiB total file size
Block size 16KiB
Number of IO requests: 0
Read/Write ratio for combined random IO test: 1.50
Periodic FSYNC enabled, calling fsync() each 100 requests.
Calling fsync() at the end of test, Enabled.
Using synchronous I/O mode
Doing random r/w test
Initializing worker threads...

Threads started!


File operations:
    reads/s:                      217249.04
    writes/s:                     144832.19
    fsyncs/s:                     463709.11

Throughput:
    read, MiB/s:                  3394.52
    written, MiB/s:               2263.00

General statistics:
    total time:                          10.0016s
    total number of events:              8257596

Latency (ms):
         min:                                    0.00
         avg:                                    0.01
         max:                                    0.24
         95th percentile:                        0.04
         sum:                               111676.02

Threads fairness:
    events (avg/stddev):           412879.8000/1631.35
    execution time (avg/stddev):   5.5838/0.03
```

![[Pasted image 20250816234556.png]]

```
>>> 1000 / 4227.80
0.2365296371635366
0.23ms

>>> 1000 / 64417
0.015523852399211389
0.016ms
```

```
-> % pg_test_fsync
5 seconds per test
O_DIRECT supported on this platform for open_datasync and open_sync.

Compare file sync methods using one 8kB write:
(in "wal_sync_method" preference order, except fdatasync is Linux's default)
        open_datasync                      1375.868 ops/sec     727 usecs/op
        fdatasync                          2047.416 ops/sec     488 usecs/op
        fsync                               761.246 ops/sec    1314 usecs/op
        fsync_writethrough                              n/a
        open_sync                           763.714 ops/sec    1309 usecs/op

Compare file sync methods using two 8kB writes:
(in "wal_sync_method" preference order, except fdatasync is Linux's default)
        open_datasync                       679.746 ops/sec    1471 usecs/op
        fdatasync                          2061.520 ops/sec     485 usecs/op
        fsync                               773.574 ops/sec    1293 usecs/op
        fsync_writethrough                              n/a
        open_sync                           380.822 ops/sec    2626 usecs/op

Compare open_sync with different write sizes:
(This is designed to compare the cost of writing 16kB in different write
open_sync sizes.)
         1 * 16kB open_sync write           765.618 ops/sec    1306 usecs/op
         2 *  8kB open_sync writes          382.928 ops/sec    2611 usecs/op
         4 *  4kB open_sync writes          191.286 ops/sec    5228 usecs/op
         8 *  2kB open_sync writes           95.753 ops/sec   10444 usecs/op
        16 *  1kB open_sync writes           48.011 ops/sec   20829 usecs/op

Test if fsync on non-write file descriptor is honored:
(If the times are similar, fsync() can sync data written on a different
descriptor.)
        write, fsync, close                 766.329 ops/sec    1305 usecs/op
        write, close, fsync                 765.836 ops/sec    1306 usecs/op

Non-sync'ed 8kB writes:
        write                            659609.902 ops/sec       2 usecs/op

fanmi@fanyang-epyc [23:51:07] [/mnt/sysbench]
-> % findmnt .
TARGET        SOURCE         FSTYPE OPTIONS
/mnt/sysbench /dev/nvme9n1p1 xfs    rw,noatime,attr2,inode64,logbufs=8,logbsize=32k,noquota
```
