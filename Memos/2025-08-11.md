[存算分离，zbs 关机一节点 elf 虚拟机无法启动](https://cs.smartx.com/cases/detail?id=1120809)

```bash
-> % rg 'waits for ongoing DoRecv' -l
cluster-logs-2025080811-2025080817-bba87c82/192_168_102_3/zbs_logs/zbs-chunkd/zbs-chunkd.log.20250801-124811.45963
cluster-logs-2025080811-2025080817-bba87c82/192_168_102_3/zbs_logs/zbs-chunkd/zbs-chunkd.log.20250808-164607.45963
```

```
fanmi@arc [13:15:05] [~/tmp/cs1120809]
-> % rg 'waits for ongoing DoRecv' -HI | sort -n | head
I0808 16:37:09.072721 45968 async_receiver.cc:25] async receiver: 0xaaabc94de6e0 waits for ongoing DoRecv, 1 remaining, socket: 192.168.101.12:10206-->192.168.101.5:42652 fd: -1
I0808 16:37:09.572748 45968 async_receiver.cc:25] async receiver: 0xaaabc94de6e0 waits for ongoing DoRecv, 1 remaining, socket: 192.168.101.12:10206-->192.168.101.5:42652 fd: -1
I0808 16:37:10.072782 45968 async_receiver.cc:25] async receiver: 0xaaabc94de6e0 waits for ongoing DoRecv, 1 remaining, socket: 192.168.101.12:10206-->192.168.101.5:42652 fd: -1
I0808 16:37:10.572817 45968 async_receiver.cc:25] async receiver: 0xaaabc94de6e0 waits for ongoing DoRecv, 1 remaining, socket: 192.168.101.12:10206-->192.168.101.5:42652 fd: -1
I0808 16:37:11.072854 45968 async_receiver.cc:25] async receiver: 0xaaabc94de6e0 waits for ongoing DoRecv, 1 remaining, socket: 192.168.101.12:10206-->192.168.101.5:42652 fd: -1
I0808 16:37:11.572887 45968 async_receiver.cc:25] async receiver: 0xaaabc94de6e0 waits for ongoing DoRecv, 1 remaining, socket: 192.168.101.12:10206-->192.168.101.5:42652 fd: -1
I0808 16:37:12.072917 45968 async_receiver.cc:25] async receiver: 0xaaabc94de6e0 waits for ongoing DoRecv, 1 remaining, socket: 192.168.101.12:10206-->192.168.101.5:42652 fd: -1
I0808 16:37:12.572950 45968 async_receiver.cc:25] async receiver: 0xaaabc94de6e0 waits for ongoing DoRecv, 1 remaining, socket: 192.168.101.12:10206-->192.168.101.5:42652 fd: -1
I0808 16:37:13.072985 45968 async_receiver.cc:25] async receiver: 0xaaabc94de6e0 waits for ongoing DoRecv, 1 remaining, socket: 192.168.101.12:10206-->192.168.101.5:42652 fd: -1
I0808 16:37:13.573015 45968 async_receiver.cc:25] async receiver: 0xaaabc94de6e0 waits for ongoing DoRecv, 1 remaining, socket: 192.168.101.12:10206-->192.168.101.5:42652 fd: -1

fanmi@arc [13:15:11] [~/tmp/cs1120809]
-> % rg 'waits for ongoing DoRecv' -HI | sort -n | tail
I0808 16:53:31.223021 45968 async_receiver.cc:25] async receiver: 0xaaabbce1f080 waits for ongoing DoRecv, 1 remaining, socket: 192.168.101.12:10206-->192.168.101.3:44998 fd: -1
I0808 16:53:31.223030 45968 async_receiver.cc:25] async receiver: 0xaaabbce1f970 waits for ongoing DoRecv, 1 remaining, socket: 192.168.101.12:10206-->192.168.101.3:40228 fd: -1
I0808 16:53:31.223165 45968 async_receiver.cc:25] async receiver: 0xaaabc94de790 waits for ongoing DoRecv, 1 remaining, socket: 192.168.101.12:10206-->192.168.101.4:38642 fd: -1
I0808 16:53:31.223193 45968 async_receiver.cc:25] async receiver: 0xaaabcbfe8630 waits for ongoing DoRecv, 1 remaining, socket: 192.168.101.12:10206-->192.168.101.7:37922 fd: -1
I0808 16:53:31.223202 45968 async_receiver.cc:25] async receiver: 0xaaabb14e91e0 waits for ongoing DoRecv, 1 remaining, socket: 192.168.101.12:10206-->192.168.101.4:38654 fd: -1
I0808 16:53:31.223209 45968 async_receiver.cc:25] async receiver: 0xaaabbce1fe40 waits for ongoing DoRecv, 1 remaining, socket: 192.168.101.12:10206-->192.168.101.8:54154 fd: -1
I0808 16:53:31.223215 45968 async_receiver.cc:25] async receiver: 0xaaabc912a8f0 waits for ongoing DoRecv, 1 remaining, socket: 192.168.101.12:10206-->192.168.101.7:42738 fd: -1
I0808 16:53:31.223246 45968 async_receiver.cc:25] async receiver: 0xaaabed012e70 waits for ongoing DoRecv, 1 remaining, socket: 192.168.101.12:10206-->192.168.101.5:46444 fd: -1
I0808 16:53:31.223255 45968 async_receiver.cc:25] async receiver: 0xaaabbce1efd0 waits for ongoing DoRecv, 1 remaining, socket: 192.168.101.12:10206-->192.168.101.7:35860 fd: -1
I0808 16:53:31.223409 45968 async_receiver.cc:25] async receiver: 0xaaabcbfe98c0 waits for ongoing DoRecv, 1 remaining, socket: 192.168.101.12:10206-->192.168.101.7:35658 fd: -1
```

持续时间：`0808 16:37:09.072721 ~ 0808 16:53:31.223409`，持续 16:22 秒。

客户需要验证以下两个问题

1. 当前 zbs 为 3 节点，如果顺序将两个节点关机，数据是否存在丢失（已告知客户 3 节点中断 2 节点后业务不可用）。重新开启节点后，数据是否可以自行恢复
2. 基于问题 1，客户关闭 zbs 节点 2，此时将原来为关闭状态的虚拟机（fio01）开机，开机报错“连接存储服务失败”

## 操作

- 当关闭 zbs 节点 2 时候(客户前往机房手动按下服务器面板开关将服务器关机)，除 fio01 虚拟机无法正常开机，其他已开机的虚拟机正常，可以重启
  - 但是 fio07（原始状态为开机状态），关机后无法再次开机，报错也是连接存储服务异常
- 查看 elf 报错细节，发现 `"error code":"EconnectError","error msg":"Traceback:\n[EconnectError] calling "lun get via zbs client timed out"}`
- 第一次失败后，将 zbs 节点 2 重新开机，通过带外强制关机，发现无类似问题
- 第三次关机，一线和客户前往机房关闭节点，无类似问题
- 时间线： 第一次硬件面板关机：4：37 分左右，tower 产生告警，但是一线未登录 ipmi 查看服务器状态，ping zbs 节点测试中断。客户反馈服务器已经关闭

```
-> % rg 'Reading conf' $(fd zookeeper.log)
192_168_102_3/base_component_logs/zookeeper/zookeeper.log
1:2025-08-01T12:45:41,081 [myid:] - INFO  [main:QuorumPeerConfig@138] - Reading configuration from: /etc/zookeeper/zoo.cfg

192_168_102_1/base_component_logs/zookeeper/zookeeper.log
1:2025-08-01T12:45:40,388 [myid:] - INFO  [main:QuorumPeerConfig@138] - Reading configuration from: /etc/zookeeper/zoo.cfg

192_168_102_2/base_component_logs/zookeeper/zookeeper.log
1:2025-08-01T12:45:39,251 [myid:] - INFO  [main:QuorumPeerConfig@138] - Reading configuration from: /etc/zookeeper/zoo.cfg

# op 1
247964:2025-08-08T16:56:32,041 [myid:] - INFO  [main:QuorumPeerConfig@138] - Reading configuration from: /etc/zookeeper/zoo.cfg

# op 2
248369:2025-08-08T17:10:05,441 [myid:] - INFO  [main:QuorumPeerConfig@138] - Reading configuration from: /etc/zookeeper/zoo.cfg

# op 3
248781:2025-08-08T17:32:32,050 [myid:] - INFO  [main:QuorumPeerConfig@138] - Reading configuration from: /etc/zookeeper/zoo.cfg
```

```json
{ "ctime": 1754642970, "vm_name": "fio01", "description": "克隆自 owl-oula" }
```

```
-> % date -d @1754642970
Fri Aug  8 04:49:30 PM CST 2025
```

```python
class _ISCSIClientCache:
    def __init__(self):
        self._iscsi_client_cache_map = {}

    def get_iscsi_client(self, storage_cluster_uuid):
        key = storage_cluster_uuid or "default_smtxos_storage_cluster_uuid"

        if not self._iscsi_client_cache_map.get(key):
            self._iscsi_client_cache_map[key] = zbs_iscsi.ZbsClientWrapper(
                sc_utils.init_zbs_iscsi_client(storage_cluster_uuid)
            )

        return self._iscsi_client_cache_map[key]
```

```
2025-08-08T16:56:37.748327807+08:00 stderr F I0808 08:56:37.747981       1 migrate/component.go:58] migrate service iscsi from taskd: done
2025-08-08T16:56:37.748327807+08:00 stderr F I0808 08:56:37.747994       1 migrate/component.go:45] stop component migrator
// ~15min
2025-08-08T17:10:11.511794030+08:00 stderr F I0808 09:10:11.491688       1 config/dynamic.go:182] start handle config /etc/zbs/zbs.conf update event
2025-08-08T17:10:11.511794030+08:00 stderr F I0808 09:10:11.491873       1 migrate/component.go:38] start component migrator
```

作为对比的 Dogfood `SMTXZBS-Dogfood-5.x-17.73`

![[Pasted image 20250812161822.png]]

## CS1118151

```bash
-> % rg -B1 'Read timed out'
10_10_10_148/base_component_logs/zookeeper/zookeeper.log.9
24197-2025-08-04T19:30:42,366 [myid:] - WARN  [QuorumPeer[myid=3](plain=10.10.10.148:2181)(secure=disabled):Follower@100] - Exception when following the leader
24198:java.net.SocketTimeoutException: Read timed out

10_10_10_153/base_component_logs/zookeeper/zookeeper.log
152660-2025-08-04T19:30:42,417 [myid:] - WARN  [QuorumPeer[myid=5](plain=10.10.10.153:2181)(secure=disabled):Follower@100] - Exception when following the leader
152661:java.net.SocketTimeoutException: Read timed out
--
331837-2025-08-10T00:34:31,879 [myid:] - ERROR [LearnerHandler-/10.10.10.147:57424:LearnerHandler@619] - Unexpected exception causing shutdown while sock still open
331838:java.net.SocketTimeoutException: Read timed out
--
332062-2025-08-10T00:45:10,346 [myid:] - ERROR [LearnerHandler-/10.10.10.147:60402:LearnerHandler@619] - Unexpected exception causing shutdown while sock still open
332063:java.net.SocketTimeoutException: Read timed out
--
332136-2025-08-10T00:47:28,961 [myid:] - ERROR [LearnerHandler-/10.10.10.147:45654:LearnerHandler@619] - Unexpected exception causing shutdown while sock still open
332137:java.net.SocketTimeoutException: Read timed out
```

```
00:23:57 => + 10min 34s => 634s
00:34:31
```

![[Pasted image 20250811180811.png]]

![[Pasted image 20250811180920.png]]

## Day 2

```bash
// Node1 视角
I0805 15:03:59.760372 49919 zbs_rpc_proxy.cc:76] Found leader from zk: 192.168.102.2:10100

// Node3 视角
I0805 15:03:51.727691 45968 zbs_rpc_proxy.cc:76] Found leader from zk: 192.168.102.2:10100
W0808 16:37:00.444618 45968 proto_async_client.h:470] EPOLLERR received: 192.168.102.3:36394-->192.168.102.2:10101 fd: 479
I0808 16:37:09.072721 45968 async_receiver.cc:25] async receiver: 0xaaabc94de6e0 waits for ongoing DoRecv, 1 remaining, socket: 192.168.101.12:10206-->192.168.101.5:42652 fd: -1
```

```bash
192_168_102_3/zbs_logs/zbs-chunkd/zbs-chunkd.log.20250808-164607.45963
E0808 16:53:58.501737 45968 zbs_rpc_proxy.cc:72] Fail to refresh meta leader:
I0808 16:54:09.450856 45968 zbs_rpc_proxy.cc:76] Found leader from zk: 192.168.102.3:10100
```

```
-> % rg '0808.+quorum_cluster.cc.+Leader\sis' $(fd zbs-metad.log)
192_168_102_2/zbs_logs/zbs-metad/zbs-metad.log.20250808-165632.4299
47:I0808 16:56:32.871785  4353 quorum_cluster.cc:490] Leader is 192.168.102.3:10100. seq is 6

192_168_102_2/zbs_logs/zbs-metad/zbs-metad.log.20250808-171006.4271
47:I0808 17:10:06.393563  4307 quorum_cluster.cc:490] Leader is 192.168.102.3:10100. seq is 6

192_168_102_1/zbs_logs/zbs-metad/zbs-metad.log.20250801-124822.52848
640:I0808 16:37:01.465869 1753267 quorum_cluster.cc:490] Leader is 192.168.102.2:10100. seq is 5

643:I0808 16:37:02.969406 1753267 quorum_cluster.cc:490] Leader is 192.168.102.3:10100. seq is 6
662:I0808 16:56:33.289212 1753267 quorum_cluster.cc:490] Leader is 192.168.102.3:10100. seq is 6
668:I0808 17:03:06.667877 1753267 quorum_cluster.cc:490] Leader is 192.168.102.3:10100. seq is 6
674:I0808 17:10:07.047035 1753267 quorum_cluster.cc:490] Leader is 192.168.102.3:10100. seq is 6
680:I0808 17:16:08.167426 1753267 quorum_cluster.cc:490] Leader is 192.168.102.3:10100. seq is 6
687:I0808 17:32:32.515125 1753267 quorum_cluster.cc:490] Leader is 192.168.102.3:10100. seq is 6

192_168_102_2/zbs_logs/zbs-metad/zbs-metad.log.20250808-173232.4215
47:I0808 17:32:32.710389  4283 quorum_cluster.cc:490] Leader is 192.168.102.3:10100. seq is 6
```

```
// Node3 meta
I0808 16:37:02.967518 3163687 quorum_cluster.cc:479] [ROLE CHANGE] I am the leader now.  seq is 6
```
