故障时间点：
![[企业微信截图_17537046709702.png]]
2025-07-28 8:0x 分触发故障，Node 6 和 node 3
计算时间：约

```
Node05-tcpdump-trace-250728-193447-fixed.pcap0  19:34:47，距离 08:00 间隔 35min13s = 35*60+13 = 2113
```

在日志中寻找报警：

```
-> % rg 'Peer state change'
```

可以发现，故障从 `2025-07-28T19:54:53` 开始，到 `2025-07-28T20:06:17` 结束。
所以，在 node05 pcap 的第一个 cluster 应该是：`(54-34)*60 + 6 == 1206`，最后一个是 2490

```
################# cmd: zbs-meta chunk list #################

ID IP Host Name Port Storage Pool Use State Link Status Data Capacity Used Space Provisioned Space Allocated Space Failure Data Space Failure Cache Space Cache Capacity Used Cache Space Registered Date LSM Version Zone Maintenance Mode

---- ------------ ----------- ------ -------------- ----------- ----------------- --------------- ------------ ------------------- ----------------- -------------------- --------------------- ---------------- ------------------ ------------------- ------------- ------- ------------------

1 10.10.10.146 smtx-node1 10200 system IN_USE CONNECTED_HEALTHY 27.64 TiB 19.35 TiB 19.35 TiB 14.28 TiB 0.00 B 0.00 B 0.00 B 0.00 B 2023-06-27 16:21:43 2.3.0 default False

2 10.10.10.147 smtx-node2 10200 system IN_USE CONNECTED_HEALTHY 27.64 TiB 20.94 TiB 20.94 TiB 20.43 TiB 0.00 B 0.00 B 0.00 B 0.00 B 2023-06-27 16:21:44 2.3.0 default False

3 10.10.10.148 smtx-node3 10200 system IN_USE CONNECTED_HEALTHY 27.64 TiB 18.94 TiB 18.94 TiB 17.96 TiB 0.00 B 0.00 B 0.00 B 0.00 B 2023-06-27 16:21:46 2.3.0 default False

4 10.10.10.149 smtx-node4 10200 system IN_USE CONNECTED_HEALTHY 27.64 TiB 15.80 TiB 15.80 TiB 14.71 TiB 0.00 B 0.00 B 0.00 B 0.00 B 2024-02-04 11:36:24 2.3.0 default False

5 10.10.10.154 smtx-node7 10200 system IN_USE CONNECTED_HEALTHY 27.64 TiB 20.73 TiB 20.73 TiB 20.14 TiB 0.00 B 0.00 B 0.00 B 0.00 B 2024-08-12 15:41:44 2.3.0 default False

6 10.10.10.153 smtx-node6 10200 system IN_USE CONNECTED_HEALTHY 27.64 TiB 15.73 TiB 15.73 TiB 14.81 TiB 0.00 B 0.00 B 0.00 B 0.00 B 2024-08-12 15:41:55 2.3.0 default False

7 10.10.10.152 smtx-node5 10200 system IN_USE CONNECTED_HEALTHY 27.64 TiB 20.15 TiB 20.15 TiB 18.68 TiB 0.00 B 0.00 B 0.00 B 0.00 B 2024-08-12 15:44:55 2.3.0 default False

8 10.10.10.155 smtx-node8 10200 system IN_USE CONNECTED_HEALTHY 27.64 TiB 16.45 TiB 16.45 TiB 14.75 TiB 0.00 B 0.00 B 0.00 B 0.00 B 2025-03-12 16:08:22 2.3.0 default False

9 10.10.10.156 smtx-node9 10200 system IN_USE CONNECTED_HEALTHY 27.64 TiB 15.78 TiB 15.78 TiB 10.13 TiB 0.00 B 0.00 B 0.00 B 0.00 B 2025-03-12 16:08:22 2.3.0 default False
```

```
fanyang@Mac-mini [14:53:58] [~/workspace/pcap-sherlock/test-data/cluster-logs-2025072717-2025072820-bad642b2/10_10_10_148] [main *]
-> % grep -i 'peer state' base_component_logs/zookeeper/zookeeper.log
2025-07-28T19:54:52,710 [myid:] - INFO  [QuorumPeer[myid=3](plain=10.10.10.148:2181)(secure=disabled):QuorumPeer@751] - Peer state changed: looking
2025-07-28T19:54:53,118 [myid:] - INFO  [QuorumPeer[myid=3](plain=10.10.10.148:2181)(secure=disabled):QuorumPeer@745] - Peer state changed: following
2025-07-28T19:54:53,118 [myid:] - INFO  [QuorumPeer[myid=3](plain=10.10.10.148:2181)(secure=disabled):QuorumPeer@751] - Peer state changed: following - discovery
2025-07-28T19:54:54,131 [myid:] - INFO  [QuorumPeer[myid=3](plain=10.10.10.148:2181)(secure=disabled):QuorumPeer@751] - Peer state changed: following - synchronization

2025-07-28T19:55:14,151 [myid:] - INFO  [QuorumPeer[myid=3](plain=10.10.10.148:2181)(secure=disabled):QuorumPeer@751] - Peer state changed: looking
2025-07-28T19:55:14,352 [myid:] - INFO  [QuorumPeer[myid=3](plain=10.10.10.148:2181)(secure=disabled):QuorumPeer@745] - Peer state changed: following
2025-07-28T19:55:14,353 [myid:] - INFO  [QuorumPeer[myid=3](plain=10.10.10.148:2181)(secure=disabled):QuorumPeer@751] - Peer state changed: following - discovery
2025-07-28T19:55:35,374 [myid:] - INFO  [QuorumPeer[myid=3](plain=10.10.10.148:2181)(secure=disabled):QuorumPeer@751] - Peer state changed: looking
2025-07-28T19:55:36,185 [myid:] - INFO  [QuorumPeer[myid=3](plain=10.10.10.148:2181)(secure=disabled):QuorumPeer@745] - Peer state changed: leading
// ... ???
2025-07-28T20:10:58,755 [myid:] - INFO  [QuorumPeer[myid=3](plain=10.10.10.148:2181)(secure=disabled):QuorumPeer@751] - Peer state changed: leading - discovery

2025-07-28T20:15:38,591 [myid:] - INFO  [QuorumPeer[myid=3](plain=10.10.10.148:2181)(secure=disabled):QuorumPeer@751] - Peer state changed: looking
2025-07-28T20:15:38,593 [myid:] - INFO  [QuorumPeer[myid=3](plain=10.10.10.148:2181)(secure=disabled):QuorumPeer@745] - Peer state changed: following
2025-07-28T20:15:38,593 [myid:] - INFO  [QuorumPeer[myid=3](plain=10.10.10.148:2181)(secure=disabled):QuorumPeer@751] - Peer state changed: following - discovery
2025-07-28T20:15:38,596 [myid:] - INFO  [QuorumPeer[myid=3](plain=10.10.10.148:2181)(secure=disabled):QuorumPeer@751] - Peer state changed: following - synchronization
2025-07-28T20:15:38,597 [myid:] - INFO  [QuorumPeer[myid=3](plain=10.10.10.148:2181)(secure=disabled):QuorumPeer@756] - Peer state changed: following - synchronization - snap
2025-07-28T20:15:39,511 [myid:] - INFO  [QuorumPeer[myid=3](plain=10.10.10.148:2181)(secure=disabled):QuorumPeer@756] - Peer state changed: following - synchronization
2025-07-28T20:15:39,513 [myid:] - INFO  [QuorumPeer[myid=3](plain=10.10.10.148:2181)(secure=disabled):QuorumPeer@751] - Peer state changed: following - broadcast
```

## 10.10.10.152 smtx-node5

![[Pasted image 20250729150137.png]]

![[Pasted image 20250729150229.png]]

```
2025-07-28T19:54:28,038 [myid:] - INFO  [NIOWorkerThread-2:ZooKeeperServer@1179] - auth success /10.10.10.154:34208
2025-07-28T19:54:28,973 [myid:] - INFO  [NIOWorkerThread-2:QuorumZooKeeperServer@157] - Submitting global closeSession request for session 0x406d891ae7ed5ec
2025-07-28T19:54:29,999 [myid:] - INFO  [PurgeTask:DatadirCleanupManager$PurgeTask@138] - Purge task started.
2025-07-28T19:54:29,999 [myid:] - INFO  [PurgeTask:FileTxnSnapLog@115] - zookeeper.snapshot.trust.empty : false
2025-07-28T19:54:29,999 [myid:] - INFO  [PurgeTask:DatadirCleanupManager$PurgeTask@144] - Purge task completed.
2025-07-28T19:54:33,432 [myid:] - INFO  [NIOWorkerThread-1:ZooKeeperServer@1161] - got auth packet /10.10.10.148:42870
2025-07-28T19:54:33,432 [myid:] - INFO  [NIOWorkerThread-1:ZooKeeperServer@1179] - auth success /10.10.10.148:42870
2025-07-28T19:54:34,345 [myid:] - INFO  [NIOWorkerThread-1:QuorumZooKeeperServer@157] - Submitting global closeSession request for session 0x406d891ae7ed5ed
// ...
2025-07-28T19:54:59,713 [myid:] - ERROR [LearnerHandler-/10.10.10.148:51938:LearnerHandler@615] - Unexpected exception causing shutdown while sock still open
java.net.SocketTimeoutException: Read timed out
        at java.net.SocketInputStream.socketRead0(Native Method) ~[?:1.8.0_402]
        at java.net.SocketInputStream.socketRead(SocketInputStream.java:116) ~[?:1.8.0_402]
        at java.net.SocketInputStream.read(SocketInputStream.java:171) ~[?:1.8.0_402]
        at java.net.SocketInputStream.read(SocketInputStream.java:141) ~[?:1.8.0_402]
        at java.net.SocketInputStream.read(SocketInputStream.java:224) ~[?:1.8.0_402]
        at java.io.FilterInputStream.read(FilterInputStream.java:83) ~[?:1.8.0_402]
        at java.io.PushbackInputStream.read(PushbackInputStream.java:139) ~[?:1.8.0_402]
        at java.io.DataInputStream.readInt(DataInputStream.java:387) ~[?:1.8.0_402]
        at org.apache.jute.BinaryInputArchive.readInt(BinaryInputArchive.java:84) ~[zookeeper-3.9.9.jar:3.9.9-66d5735a175a824e9804d74497cb1023086dbd6a]
        at org.apache.zookeeper.server.quorum.QuorumPacket.deserialize(QuorumPacket.java:86) ~[zookeeper-3.9.9.jar:3.9.9-66d5735a175a824e9804d74497cb1023086dbd6a]
        at org.apache.jute.BinaryInputArchive.readRecord(BinaryInputArchive.java:118) ~[zookeeper-3.9.9.jar:3.9.9-66d5735a175a824e9804d74497cb1023086dbd6a]
        at org.apache.zookeeper.server.quorum.LearnerHandler.run(LearnerHandler.java:525) [zookeeper-3.9.9.jar:3.9.9-66d5735a175a824e9804d74497cb1023086dbd6a]
2025-07-28T19:54:59,714 [myid:] - WARN  [LearnerHandler-/10.10.10.148:51938:LearnerHandler@630] - ******* GOODBYE /10.10.10.148:51938 ********
```

可以发现，152 隔了一段时间，不知道在干嘛。

```
// 148 视角
2025-07-28T19:54:49,783 [myid:] - INFO  [NIOWorkerThread-1:StatCommand@53] - Stat command output
2025-07-28T19:54:52,499 [myid:] - WARN  [QuorumPeer[myid=3](plain=10.10.10.148:2181)(secure=disabled):Follower@100] - Exception when following the leader
java.net.SocketTimeoutException: Read timed out
        at java.net.SocketInputStream.socketRead0(Native Method) ~[?:1.8.0_402]
        at java.net.SocketInputStream.socketRead(SocketInputStream.java:116) ~[?:1.8.0_402]
        at java.net.SocketInputStream.read(SocketInputStream.java:171) ~[?:1.8.0_402]
        at java.net.SocketInputStream.read(SocketInputStream.java:141) ~[?:1.8.0_402]
        at java.net.SocketInputStream.read(SocketInputStream.java:224) ~[?:1.8.0_402]
        at java.io.DataInputStream.readInt(DataInputStream.java:387) ~[?:1.8.0_402]
        at org.apache.jute.BinaryInputArchive.readInt(BinaryInputArchive.java:84) ~[zookeeper-3.9.9.jar:3.9.9-66d5735a175a824e9804d74497cb1023086dbd6a]
        at org.apache.zookeeper.server.quorum.QuorumPacket.deserialize(QuorumPacket.java:86) ~[zookeeper-3.9.9.jar:3.9.9-66d5735a175a824e9804d74497cb1023086dbd6a]
        at org.apache.jute.BinaryInputArchive.readRecord(BinaryInputArchive.java:118) ~[zookeeper-3.9.9.jar:3.9.9-66d5735a175a824e9804d74497cb1023086dbd6a]
        at org.apache.zookeeper.server.quorum.Learner.readPacket(Learner.java:166) ~[zookeeper-3.9.9.jar:3.9.9-66d5735a175a824e9804d74497cb1023086dbd6a]
        at org.apache.zookeeper.server.quorum.Follower.followLeader(Follower.java:96) [zookeeper-3.9.9.jar:3.9.9-66d5735a175a824e9804d74497cb1023086dbd6a]
        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:1347) [zookeeper-3.9.9.jar:3.9.9-66d5735a175a824e9804d74497cb1023086dbd6a]
2025-07-28T19:54:52,500 [myid:] - INFO  [QuorumPeer[myid=3](plain=10.10.10.148:2181)(secure=disabled):Follower@206] - shutdown called
java.lang.Exception: shutdown Follower
        at org.apache.zookeeper.server.quorum.Follower.shutdown(Follower.java:206) [zookeeper-3.9.9.jar:3.9.9-66d5735a175a824e9804d74497cb1023086dbd6a]
        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:1351) [zookeeper-3.9.9.jar:3.9.9-66d5735a175a824e9804d74497cb1023086dbd6a]
2025-07-28T19:54:52,500 [myid:] - INFO  [QuorumPeer[myid=3](plain=10.10.10.148:2181)(secure=disabled):LearnerZooKeeperServer@183] - Shutting down
```

148 在 `19:54:52,499` 超时，需要检查 152 `19:54:51,499`

```
[root@dogfood-idc-elf-109-GPU-A16 17:07:43 ~]$ ps -o pid,tid,psr,comm -L -p $(pidof java)
  PID   TID PSR COMMAND
 8313  8313   1 java
 8313  8316   1 java
 8313  8317   1 Gang worker#0 (
 8313  8318   1 G1 Concurrent R
 8313  8319   1 G1 Concurrent R
 8313  8320   1 G1 Main Concurr
 8313  8321   1 Gang worker#0 (
 8313  8322   1 VM Thread
 8313  8323   1 Reference Handl
 8313  8325   1 Finalizer
 8313  8326   1 Surrogate Locke
 8313  8327   1 Signal Dispatch
 8313  8328   1 C2 CompilerThre
 8313  8329   1 C1 CompilerThre

[root@dogfood-idc-elf-109-GPU-A16 17:09:22 ~]$ ps -o pid,tid,psr,comm -L -p $(pidof java) | awk '{print $2}' | xargs -I{} taskset -pc {}
taskset: invalid PID argument: 'TID'
pid 8313's current affinity list: 1
pid 8316's current affinity list: 1
pid 8317's current affinity list: 1
pid 8318's current affinity list: 1
pid 8319's current affinity list: 1
pid 8320's current affinity list: 1
pid 8321's current affinity list: 1
pid 8322's current affinity list: 1

-> % numactl -H
available: 1 nodes (0)
node 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
node 0 size: 47297 MB
node 0 free: 9728 MB
node distances:
node     0
   0:   10
```

![[Pasted image 20250729172823.png]]

![[Pasted image 20250729173733.png]]
