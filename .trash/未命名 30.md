---
title: 未命名
---
# 未命名

| 步骤  | raft leader                                                     | raft follower                                         |
| --- | --------------------------------------------------------------- | ----------------------------------------------------- |
| 1   | 执行日志复制，发送 AppendEntry rpc 到 follower                            |                                                       |
| 2   |                                                                 | 发现自己落后 leader 太多无法追加日志，回复 leader 自己期望的下一条日志 index。    |
| 3   | 收到回复后记录下 follower 期望追加的下一条日志                                    |                                                       |
| 4   | 再次执行 AppendEntry 时，发现自己现在没有持有（回收了）raft follower 需要的日志，无法进行增量同步。 |                                                       |
| 5   | 开始快照同步，获取上一次 snapshot 的 id，发送 InstallSnapshot rpc 到 follower    |                                                       |
| 6   |                                                                 | 收到 InstallSnapshot rpc，开始主动从 leader 同步快照所包含的全量数据到状态机。 |
| 7   |                                                                 | 发送包含快照 id 的 PullSnapshot rpc 到 leader。                |
| 8   | 从应用状态机中获取全量/部分快照数据，并返回给 follower。                               |                                                       |
| 9   |                                                                 | 将全量/部分快照同步到应用状态机中。                                    |
| 10  |                                                                 | 不断重复 7-9 步骤，直至同步完成全部快照数据。                             |
