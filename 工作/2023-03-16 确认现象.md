日志：cluster-logs-2023031409-2023031411-d1d5cec5

## 描述

有一个测试现象跟确认一下，当我做优先可用域故障测试时，等了16分钟 leader 挂载仲裁节点上，当我把优先可用域的节点恢复后，这个 leader 会切换回优先可用域的主节点上
开始测试的时候应该在9点50分左右
集群节点手动拉起来的时候应该是在10点25分钟左右

加入故障：
![](assets/wecom-temp-239362-467799719a6bd776f692edf86a343690.jpg)

恢复后：
![](assets/wecom-temp-230096-d7769ff25eeae3f5936264265f212dd7.jpg)

# 调查

Sid=3

```bash
2023-03-14T09:59:46,654 [myid:] - WARN  [NIOWorkerThread-2:NIOServerCnxn@366] - Unable to read additional data from client sessionid 0x3000006a4d20036, like
ly client has closed socket
2023-03-14T09:59:46,697 [myid:] - INFO  [NIOWorkerThread-1:QuorumZooKeeperServer@157] - Submitting global closeSession request for session 0x400000089520014
2023-03-14T09:59:46,727 [myid:] - WARN  [NIOWorkerThread-1:NIOServerCnxn@366] - Unable to read additional data from client sessionid 0x400011dc31a615e, like
ly client has closed socket
# 2023-03-14T09:59:46 ~ 2023-03-14T10:32:25
2023-03-14T10:32:25,837 [myid:] - INFO  [main:QuorumPeerConfig@137] - Reading configuration from: /etc/zookeeper/zoo.cfg
2023-03-14T10:32:25,863 [myid:] - INFO  [main:QuorumPeerConfig@381] - clientPort is not set
2023-03-14T10:32:25,863 [myid:] - INFO  [main:QuorumPeerConfig@395] - secureClientPort is not set
```

Sid=4

```bash
2023-03-14T09:59:46,684 [myid:] - WARN  [NIOWorkerThread-3:NIOServerCnxn@366] - Unable to read additional data from client sessionid 0x400000098480153, likely client has closed socket
2023-03-14T09:59:46,684 [myid:] - WARN  [NIOWorkerThread-1:NIOServerCnxn@366] - Unable to read additional data from client sessionid 0x400000098480157, likely client has closed socket
2023-03-14T09:59:46,688 [myid:] - WARN  [NIOWorkerThread-2:NIOServerCnxn@366] - Unable to read additional data from client sessionid 0x400000098480156, likely client has closed socket
2023-03-14T09:59:47,267 [myid:] - INFO  [CommitProcWorkThread-2:LearnerSessionTracker@121] - Committing global session 0x2000bc399df2113
# 2023-03-14T09:59:47~2023-03-14T10:32:32
2023-03-14T10:32:32,545 [myid:] - INFO  [main:QuorumPeerConfig@137] - Reading configuration from: /etc/zookeeper/zoo.cfg
2023-03-14T10:32:32,551 [myid:] - INFO  [main:QuorumPeerConfig@381] - clientPort is not set
2023-03-14T10:32:32,551 [myid:] - INFO  [main:QuorumPeerConfig@395] - secureClientPort is not set
```

```bash
# mainline
2023-03-14T09:59:49,122 [myid:] - WARN  [RecvWorker:4:QuorumCnxManager$RecvWorker@1251] - Connection broken for id 4, my id = 2, error =
2023-03-14T09:59:49,335 [myid:] - INFO  [QuorumPeer[myid=1](plain=138.95.3.11:2181)(secure=disabled):QuorumPeer@751] - Peer state changed: looking
2023-03-14T09:59:49,370 [myid:] - INFO  [QuorumPeer[myid=2](plain=138.95.3.12:2181)(secure=disabled):QuorumPeer@751] - Peer state changed: looking
2023-03-14T09:59:49,395 [myid:] - INFO  [QuorumPeer[myid=5](plain=128.32.190.28:2181)(secure=disabled):QuorumPeer@751] - Peer state changed: looking
```

update：关的就是 3，4，所以正常。

检查之后是否正常。

```
2023-03-14T10:15:26,409 [myid:] - INFO  [QuorumPeer[myid=2](plain=138.95.3.12:2181)(secure=disabled):QuorumPeer@1345] - FOLLOWING
2023-03-14T10:15:26,424 [myid:] - INFO  [QuorumPeer[myid=1](plain=138.95.3.11:2181)(secure=disabled):QuorumPeer@1345] - FOLLOWING
2023-03-14T10:15:26,426 [myid:] - INFO  [QuorumPeer[myid=5](plain=128.32.190.28:2181)(secure=disabled):QuorumPeer@1357] - LEADING
```

```
2023-03-14T10:32:25,837 [myid:] - INFO  [main:QuorumPeerConfig@137] - Reading configuration from: /etc/zookeeper/zoo.cfg
myid3
```

```

```

```

│2023-03-14T10:32:32,913 [myid:] - WARN  [RecvWorker:5:QuorumCnxManager$RecvWorker@1251] - Connection broken for id 5, my id = 2, error =                                                                                                                                                          │
│java.io.EOFException: null

2023-03-14T10:32:32

2023-03-14T10:32:32,539 [myid:] - INFO  [NIOWorkerThread-2:StatCommand@53] - Stat command output
2023-03-14T10:32:34,425 [myid:] - INFO  [main:QuorumPeerConfig@137] - Reading configuration from: /etc/zookeeper/zoo.cfg
2023-03-14T10:32:34,431 [myid:] - INFO  [main:QuorumPeerConfig@381] - clientPort is not set
2023-03-14T10:32:34,432 [myid:] - INFO  [main:QuorumPeerConfig@395] - secureClientPort is not set
```
