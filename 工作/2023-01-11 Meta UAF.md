```C++
class GcManager {
    ThreadContextPtr thctx_;
};

Status DBClusterClient::CreateSnapshot(const string& db_name, int64_t * snap_seq) {
    CHECK_STOPPED();
    RpcStatus status;
    Coroutine* co = Coroutine::Self();

    CreateDbSnapshotRequest request;
    DbSnapshotItemsResponse response;
    *(request.mutable_db_name()) = db_name;
    request.set_refresh_flag(true);
    DbOpCtx ctx;
    ctx.op_code = RoutineCode::CREATE_SNAPSHOT;
    auto thctx = ThreadContext::Self();
    ctx.cb = [thctx, co]() { thctx->Sched(co); };   // <---- 调用 thctx 时，thctx 可能已经析构
    ctx.create_db_snapshot.request = &request;
    ctx.create_db_snapshot.response = &response;

    db_cluster_->Submit(&ctx);
    co->Yield();

    RETURN_IF_RPC_ERROR(response.rpc_status());

    *snap_seq = response.op_seq();
    return Status::OK();
}
```

```
==12689==ERROR: AddressSanitizer: heap-use-after-free on address 0x61800002e880 at pc 0x556ddceff25a bp 0x7f90ee5ff690 sp 0x7f90ee5ff680
READ of size 8 at 0x61800002e880 thread T16 (db-cluster-io)
    #0 0x556ddceff259 in operator() ../src/consensus/db_cluster_client.cc:299
    #1 0x556ddceff259 in _M_invoke /opt/rh/devtoolset-7/root/usr/include/c++/7/bits/std_function.h:316
    #2 0x556ddced7a03 in std::function<void ()>::operator()() const /opt/rh/devtoolset-7/root/usr/include/c++/7/bits/std_function.h:706
    #3 0x556ddced7a03 in zbs::consensus::DBCluster::CreateSnapshot(zbs::consensus::CreateDbSnapshotRequest const&, zbs::consensus::DbSnapshotItemsResponse*, std::function<void ()> const&) ../src/consensus/db_cluster.cc:1397
    #4 0x556ddcefda02 in zbs::consensus::DBCluster::HandleOp(zbs::consensus::DbOpCtx*) ../src/consensus/db_cluster.cc:500
    #5 0x556ddd46e519 in zbs::CoFunc::run_and_reset() ../src/common/coroutine.h:312
    #6 0x556ddd46e519 in zbs::Coroutine::LoopMain() ../src/common/coroutine.cc:615
    #7 0x7f90ffa4918f  (/lib64/libc.so.6+0x4818f)

0x61800002e880 is located 0 bytes inside of 776-byte region [0x61800002e880,0x61800002eb88)
freed by thread T13 (quorum) here:
    #0 0x7f9104d66728 in operator delete(void*, unsigned long) (/lib64/libasan.so.4+0xe1728)
    #1 0x556ddd64868a in zbs::ThreadContext::UnregisterThread(zbs::ThreadContext*) ../src/common/thread_context.cc:304
    #2 0x556ddc0258ec in zbs::ThreadContextDeleter::operator()(zbs::ThreadContext*) ../src/common/thread_context.h:128
    #3 0x556ddc0258ec in std::unique_ptr<zbs::ThreadContext, zbs::ThreadContextDeleter>::reset(zbs::ThreadContext*) /opt/rh/devtoolset-7/root/usr/include/c++/7/bits/unique_ptr.h:376
    #4 0x556ddc0258ec in std::unique_ptr<zbs::ThreadContext, zbs::ThreadContextDeleter>::operator=(decltype(nullptr)) /opt/rh/devtoolset-7/root/usr/include/c++/7/bits/unique_ptr.h:312
    #5 0x556ddc0258ec in zbs::meta::GcManager::Stop() ../src/meta/gc_manager.cc:71
    #6 0x556ddc30c3dd in zbs::meta::MetaServer::StopGCManager() ../src/meta/meta_server.cc:222
    #7 0x556ddc30c3dd in zbs::meta::MetaServer::StopService() ../src/meta/meta_server.cc:510
    #8 0x556ddcf58d8b in zbs::consensus::QuorumServer::OnStatusChange(zbs::consensus::QuorumClusterEvent) ../src/consensus/quorum_server.cc:86
    #9 0x556ddcf2e1dc in std::function<void (zbs::consensus::QuorumClusterEvent)>::operator()(zbs::consensus::QuorumClusterEvent) const /opt/rh/devtoolset-7/root/usr/include/c++/7/bits/std_function.h:706
    #10 0x556ddcf2e1dc in zbs::consensus::QuorumCluster::OnEvent(zbs::consensus::QuorumClusterEvent) ../src/consensus/quorum_cluster.cc:279
    #11 0x556ddd46e519 in zbs::CoFunc::run_and_reset() ../src/common/coroutine.h:312
    #12 0x556ddd46e519 in zbs::Coroutine::LoopMain() ../src/common/coroutine.cc:615
    #13 0x7f90ffa4918f  (/lib64/libc.so.6+0x4818f)

previously allocated by thread T13 (quorum) here:
    #0 0x7f9104d651a8 in operator new(unsigned long) (/lib64/libasan.so.4+0xe01a8)
    #1 0x556ddd651a9f in zbs::ThreadContext::DoRegisterThread(std::string const&, bool, zbs::ThreadOptions const&, bool, bool) ../src/common/thread_context.cc:285
    #2 0x556ddc025f4a in zbs::ThreadContext::RegisterNewThread(std::string const&, zbs::ThreadOptions const&, bool, bool) ../src/common/thread_context.h:63
    #3 0x556ddc025f4a in zbs::meta::GcManager::Start() ../src/meta/gc_manager.cc:51
    #4 0x556ddc30d30b in zbs::meta::MetaServer::StartGCManager() ../src/meta/meta_server.cc:215
    #5 0x556ddc30d30b in zbs::meta::MetaServer::StartLeader() ../src/meta/meta_server.cc:344
    #6 0x556ddc30ef0f in zbs::meta::MetaServer::StartService() ../src/meta/meta_server.cc:409
    #7 0x556ddcf58fb3 in zbs::consensus::QuorumServer::OnStatusChange(zbs::consensus::QuorumClusterEvent) ../src/consensus/quorum_server.cc:79
    #8 0x556ddcf2e1dc in std::function<void (zbs::consensus::QuorumClusterEvent)>::operator()(zbs::consensus::QuorumClusterEvent) const /opt/rh/devtoolset-7/root/usr/include/c++/7/bits/std_function.h:706
    #9 0x556ddcf2e1dc in zbs::consensus::QuorumCluster::OnEvent(zbs::consensus::QuorumClusterEvent) ../src/consensus/quorum_cluster.cc:279
    #10 0x556ddd46e519 in zbs::CoFunc::run_and_reset() ../src/common/coroutine.h:312
    #11 0x556ddd46e519 in zbs::Coroutine::LoopMain() ../src/common/coroutine.cc:615
    #12 0x7f90ffa4918f  (/lib64/libc.so.6+0x4818f)

Thread T16 (db-cluster-io) created by T13 (quorum) here:
    #0 0x7f9104cbca7f in pthread_create (/lib64/libasan.so.4+0x37a7f)
    #1 0x556ddd62cf94 in zbs::Thread::Start(int) ../src/common/thread.cc:264
    #2 0x556ddd642c46 in zbs::ThreadContext::Start() ../src/common/thread_context.cc:207
    #3 0x556ddcebcd9f in zbs::consensus::DBCluster::DBCluster(zbs::consensus::QuorumCluster*, std::string const&, std::string const&, std::string const&, zbs::WatchDog*, bool, bool) ../src/consensus/db_cluster.cc:129
    #4 0x556ddc137801 in void __gnu_cxx::new_allocator<zbs::consensus::DBCluster>::construct<zbs::consensus::DBCluster, zbs::consensus::QuorumCluster*&, char const (&) [5], std::string const&, std::string const&, zbs::WatchDog*&>(zbs::consensus::DBCluster*, zbs::consensus::QuorumCluster*&, char const (&) [5], std::string const&, std::string const&, zbs::WatchDog*&) /opt/rh/devtoolset-7/root/usr/include/c++/7/ext/new_allocator.h:136
    #5 0x556ddc137801 in void std::allocator_traits<std::allocator<zbs::consensus::DBCluster> >::construct<zbs::consensus::DBCluster, zbs::consensus::QuorumCluster*&, char const (&) [5], std::string const&, std::string const&, zbs::WatchDog*&>(std::allocator<zbs::consensus::DBCluster>&, zbs::consensus::DBCluster*, zbs::consensus::QuorumCluster*&, char const (&) [5], std::string const&, std::string const&, zbs::WatchDog*&) /opt/rh/devtoolset-7/root/usr/include/c++/7/bits/alloc_traits.h:475
    #6 0x556ddc137801 in std::_Sp_counted_ptr_inplace<zbs::consensus::DBCluster, std::allocator<zbs::consensus::DBCluster>, (__gnu_cxx::_Lock_policy)2>::_Sp_counted_ptr_inplace<zbs::consensus::QuorumCluster*&, char const (&) [5], std::string const&, std::string const&, zbs::WatchDog*&>(std::allocator<zbs::consensus::DBCluster>, zbs::consensus::QuorumCluster*&, char const (&) [5], std::string const&, std::string const&, zbs::WatchDog*&) /opt/rh/devtoolset-7/root/usr/include/c++/7/bits/shared_ptr_base.h:526
    #7 0x556ddc137801 in std::__shared_count<(__gnu_cxx::_Lock_policy)2>::__shared_count<zbs::consensus::DBCluster, std::allocator<zbs::consensus::DBCluster>, zbs::consensus::QuorumCluster*&, char const (&) [5], std::string const&, std::string const&, zbs::WatchDog*&>(std::_Sp_make_shared_tag, zbs::consensus::DBCluster*, std::allocator<zbs::consensus::DBCluster> const&, zbs::consensus::QuorumCluster*&, char const (&) [5], std::string const&, std::string const&, zbs::WatchDog*&) /opt/rh/devtoolset-7/root/usr/include/c++/7/bits/shared_ptr_base.h:637
    #8 0x556ddc137801 in std::__shared_ptr<zbs::consensus::DBCluster, (__gnu_cxx::_Lock_policy)2>::__shared_ptr<std::allocator<zbs::consensus::DBCluster>, zbs::consensus::QuorumCluster*&, char const (&) [5], std::string const&, std::string const&, zbs::WatchDog*&>(std::_Sp_make_shared_tag, std::allocator<zbs::consensus::DBCluster> const&, zbs::consensus::QuorumCluster*&, char const (&) [5], std::string const&, std::string const&, zbs::WatchDog*&) /opt/rh/devtoolset-7/root/usr/include/c++/7/bits/shared_ptr_base.h:1295
    #9 0x556ddc137801 in std::shared_ptr<zbs::consensus::DBCluster>::shared_ptr<std::allocator<zbs::consensus::DBCluster>, zbs::consensus::QuorumCluster*&, char const (&) [5], std::string const&, std::string const&, zbs::WatchDog*&>(std::_Sp_make_shared_tag, std::allocator<zbs::consensus::DBCluster> const&, zbs::consensus::QuorumCluster*&, char const (&) [5], std::string const&, std::string const&, zbs::WatchDog*&) /opt/rh/devtoolset-7/root/usr/include/c++/7/bits/shared_ptr.h:344
    #10 0x556ddc137801 in std::shared_ptr<zbs::consensus::DBCluster> std::allocate_shared<zbs::consensus::DBCluster, std::allocator<zbs::consensus::DBCluster>, zbs::consensus::QuorumCluster*&, char const (&) [5], std::string const&, std::string const&, zbs::WatchDog*&>(std::allocator<zbs::consensus::DBCluster> const&, zbs::consensus::QuorumCluster*&, char const (&) [5], std::string const&, std::string const&, zbs::WatchDog*&) /opt/rh/devtoolset-7/root/usr/include/c++/7/bits/shared_ptr.h:691
    #11 0x556ddc137801 in std::shared_ptr<zbs::consensus::DBCluster> std::make_shared<zbs::consensus::DBCluster, zbs::consensus::QuorumCluster*&, char const (&) [5], std::string const&, std::string const&, zbs::WatchDog*&>(zbs::consensus::QuorumCluster*&, char const (&) [5], std::string const&, std::string const&, zbs::WatchDog*&) /opt/rh/devtoolset-7/root/usr/include/c++/7/bits/shared_ptr.h:707
    #12 0x556ddc137801 in zbs::meta::MetaContext::Initialize() ../src/meta/meta_context.cc:202
    #13 0x556ddc30e7a7 in zbs::meta::MetaServer::StartService() ../src/meta/meta_server.cc:382
    #14 0x556ddcf58fb3 in zbs::consensus::QuorumServer::OnStatusChange(zbs::consensus::QuorumClusterEvent) ../src/consensus/quorum_server.cc:79
    #15 0x556ddcf2e1dc in std::function<void (zbs::consensus::QuorumClusterEvent)>::operator()(zbs::consensus::QuorumClusterEvent) const /opt/rh/devtoolset-7/root/usr/include/c++/7/bits/std_function.h:706
    #16 0x556ddcf2e1dc in zbs::consensus::QuorumCluster::OnEvent(zbs::consensus::QuorumClusterEvent) ../src/consensus/quorum_cluster.cc:279
    #17 0x556ddd46e519 in zbs::CoFunc::run_and_reset() ../src/common/coroutine.h:312
    #18 0x556ddd46e519 in zbs::Coroutine::LoopMain() ../src/common/coroutine.cc:615
    #19 0x7f90ffa4918f  (/lib64/libc.so.6+0x4818f)

Thread T13 (quorum) created by T4 (system-manager) here:
    #0 0x7f9104cbca7f in pthread_create (/lib64/libasan.so.4+0x37a7f)
    #1 0x556ddd62cf94 in zbs::Thread::Start(int) ../src/common/thread.cc:264
    #2 0x556ddd642c46 in zbs::ThreadContext::Start() ../src/common/thread_context.cc:207
    #3 0x556ddc319933 in zbs::meta::MetaSMServer::DoStartMetaServer() ../src/meta/meta_sm.cc:244
    #4 0x556ddc319fc8 in zbs::meta::MetaSMServer::StartMetaServer() ../src/meta/meta_sm.cc:197
    #5 0x556ddc326b0c in zbs::meta::MetaSMServer::SetEnable(bool) ../src/meta/meta_sm.cc:94
    #6 0x556ddc327188 in operator() ../src/meta/meta_sm.cc:127
    #7 0x556ddc327188 in operator() ../src/common/coroutine_utils.h:94
    #8 0x556ddc327188 in s_run_and_reset ../src/common/coroutine.h:276
    #9 0x556ddd46e519 in zbs::CoFunc::run_and_reset() ../src/common/coroutine.h:312
    #10 0x556ddd46e519 in zbs::Coroutine::LoopMain() ../src/common/coroutine.cc:615
    #11 0x7f90ffa4918f  (/lib64/libc.so.6+0x4818f)

Thread T4 (system-manager) created by T0 here:
    #0 0x7f9104cbca7f in pthread_create (/lib64/libasan.so.4+0x37a7f)
    #1 0x556ddd62cf94 in zbs::Thread::Start(int) ../src/common/thread.cc:264
    #2 0x556ddd642c46 in zbs::ThreadContext::Start() ../src/common/thread_context.cc:207
    #3 0x556ddc31b3bd in zbs::meta::MetaSMServer::MetaSMServer() ../src/meta/meta_sm.cc:78
    #4 0x556de0b52f95 in zbs::meta::MetaServerTestBase::MetaServerTestBase(zbs::db::Backend) ../src/tests/meta_server_test_base.h:44
    #5 0x556de0b52f95 in zbs::meta::MetaServerStub::MetaServerStub(bool) ../src/tests/meta_server_stub.cc:60
    #6 0x556de0bd304c in zbs::test::MiniCluster::MiniCluster(int, unsigned int, unsigned int, unsigned int) ../src/tests/mini_cluster.cc:32
    #7 0x556ddf17b3da in zbs::test::FunctionalTest::SetUp() ../src/tests/functional_base.cc:40
    #8 0x556de2b68a31 in void testing::internal::HandleSehExceptionsInMethodIfSupported<testing::Test, void>(testing::Test*, void (testing::Test::*)(), char const*) ../googletest/googletest/src/gtest.cc:2599
    #9 0x556de2b68a31 in void testing::internal::HandleExceptionsInMethodIfSupported<testing::Test, void>(testing::Test*, void (testing::Test::*)(), char const*) ../googletest/googletest/src/gtest.cc:2635
    #10 0x556de2b68ef9 in testing::Test::Run() ../googletest/googletest/src/gtest.cc:2669
    #11 0x556de2b69cd8 in testing::TestInfo::Run() ../googletest/googletest/src/gtest.cc:2853
    #12 0x556de2b6b9de in testing::TestSuite::Run() ../googletest/googletest/src/gtest.cc:3012
    #13 0x556de2ba1b25 in testing::internal::UnitTestImpl::RunAllTests() ../googletest/googletest/src/gtest.cc:5870
    #14 0x556de2b6a541 in bool testing::internal::HandleSehExceptionsInMethodIfSupported<testing::internal::UnitTestImpl, bool>(testing::internal::UnitTestImpl*, bool (testing::internal::UnitTestImpl::*)(), char const*) ../googletest/googletest/src/gtest.cc:2599
    #15 0x556de2b6a541 in bool testing::internal::HandleExceptionsInMethodIfSupported<testing::internal::UnitTestImpl, bool>(testing::internal::UnitTestImpl*, bool (testing::internal::UnitTestImpl::*)(), char const*) ../googletest/googletest/src/gtest.cc:2635
    #16 0x556de2b6ab5b in testing::UnitTest::Run() ../googletest/googletest/src/gtest.cc:5444
    #17 0x556de1727d24 in RUN_ALL_TESTS() ../googletest/googletest/include/gtest/gtest.h:2293
    #18 0x556de1727d24 in main ../src/tests/test_main.cc:144
    #19 0x7f90ffa23554 in __libc_start_main (/lib64/libc.so.6+0x22554)

SUMMARY: AddressSanitizer: heap-use-after-free ../src/consensus/db_cluster_client.cc:299 in operator()
Shadow bytes around the buggy address:
  0x0c307fffdcc0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c307fffdcd0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c307fffdce0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c307fffdcf0: 00 00 00 00 00 00 00 00 00 00 fa fa fa fa fa fa
  0x0c307fffdd00: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
=>0x0c307fffdd10:[fd]fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x0c307fffdd20: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x0c307fffdd30: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x0c307fffdd40: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x0c307fffdd50: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x0c307fffdd60: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
==12689==ABORTING
```
