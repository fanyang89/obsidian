# 背景

【环境】192.168.18.76-78  
【版本】zbs-5.3.0 B4  
【操作】  
1、集群创建4个target（覆盖2/3副本，thin/thick），每个target下创建2个lun（覆盖2/3副本）；  
2、客户端192.168.25.4挂载所有磁盘执行io（vdbech带校验）；  
3、节点78故障，添加节点18.79；  
4、数据恢复正常后，77节点注入网络故障（systemctl restart network）和进程故障（meta和chunk故障）；  
【结果】  
1、节点76出现stat-server，rpc-server，watchdog的coredump  
[https://smartx1.slack.com/files/U04235CS33R/F04DM69TFEY/untitled.md](https://smartx1.slack.com/files/U04235CS33R/F04DM69TFEY/untitled.md?origin_team=T04B2HF09&origin_channel=C01D4KNCZQE)  
[https://smartx1.slack.com/files/U04235CS33R/F04E941SSDN/untitled.md](https://smartx1.slack.com/files/U04235CS33R/F04E941SSDN/untitled.md?origin_team=T04B2HF09&origin_channel=C01D4KNCZQE)  
[https://smartx1.slack.com/files/U04235CS33R/F04DYMFARMF/untitled.md](https://smartx1.slack.com/files/U04235CS33R/F04DYMFARMF/untitled.md?origin_team=T04B2HF09&origin_channel=C01D4KNCZQE)  
2、客户端io出现校验失败  
日志路径：192.168.25.4:/root/vdbench1/zyx1_log/errorlog.html

# Core1 rpc-server.core.3556.1670013413.gz

http://gerrit.smartx.com/c/zbs/+/41196
http://jira.smartx.com/browse/ZBS-21402

# Core2 stat-server.core.2576.1670005257

```
E1203 02:20:57.597393  2983 socket.cc:273] failed to accept socket.: Too many open files [24]
F1203 02:20:57.598378  2983 async_service.cc:100] Check failed: EOK == socket_->Accept(&client_socket) ([EOK] vs. [ESocketAccept])

E1203 20:00:04.496333 10021 socket.cc:273] failed to accept socket.: Too many open files [24]
F1203 20:00:04.501391 10021 async_service.cc:100] Check failed: EOK == socket_->Accept(&client_socket) ([EOK] vs. [ESocketAccept])
```

```
[root@node1 15:34:32 2022-12-05]$ ulimit -aH
core file size          (blocks, -c) unlimited
data seg size           (kbytes, -d) unlimited
scheduling priority             (-e) 0
file size               (blocks, -f) unlimited
pending signals                 (-i) 514124
max locked memory       (kbytes, -l) unlimited
max memory size         (kbytes, -m) unlimited
open files                      (-n) 65535
pipe size            (512 bytes, -p) 8
POSIX message queues     (bytes, -q) 819200
real-time priority              (-r) 0
stack size              (kbytes, -s) unlimited
cpu time               (seconds, -t) unlimited
max user processes              (-u) 514124
virtual memory          (kbytes, -v) unlimited
file locks                      (-x) unlimited
```

```
        *-disk:1
             description: SCSI Disk
             product: VOLUME
             vendor: ZBS
             physical id: 0.0.2
             bus info: scsi@4:0.0.2
             logical name: /dev/sdf
             version: 0000
             serial: bd7c79f3-0d7e-42ae-b21a-9f8bc642
             size: 300GiB (322GB)
             configuration: ansiversion=5 logicalsectorsize=512 sectorsize=512
```

```
Vdbench error log, created 18:14:30 Dec 01 2022 CST
19:48:23.683 localhost-0: 19:48:23.608 Corrupted data block for sd=sd1,lun=/dev/sdf; lba: 4,038,656,000 (0xf0b90000) xfersize=32768
19:48:23.683 localhost-0: 19:48:23.608
19:48:23.683 localhost-0: 19:48:23.609 Data block has 1 key block(s) of 32768 bytes each.
19:48:23.683 localhost-0: 19:48:23.609 All key blocks are corrupted.
19:48:23.683 localhost-0: 19:48:23.609 Key block lba: 0xf0b90000
19:48:23.683 localhost-0: 19:48:23.609    Key block of 32,768 bytes has 64 512-byte sectors.
19:48:23.683 localhost-0: 19:48:23.609    Timeline:
19:48:23.683 localhost-0: 19:48:23.627    Fri Dec 02 2022 19:47:55.762 CST Sector last written. (As found in the first corrupted sector, timestamp is taken just BEFORE the actual write).
19:48:23.683 localhost-0: 19:48:23.627    Fri Dec 02 2022 19:48:23.580 CST Key block first found to be corrupted during a read-before-write.
19:48:23.683 localhost-0: 19:48:23.627
19:48:23.683 localhost-0: 19:48:23.627    All 64 sectors in this key block are corrupted.
19:48:23.683 localhost-0: 19:48:23.627    All corruptions are of the same type:
19:48:23.683 localhost-0: 19:48:23.627    ===> Data Validation Key miscompare. Expecting key=0x01 received key=0x7e (1/126)
19:48:23.683 localhost-0: 19:48:23.627    Only the FIRST sector will be reported:
19:48:23.684 localhost-0: 19:48:23.628
19:48:23.684 localhost-0: 19:48:23.628         Data Validation error for sd=sd1,lun=/dev/sdf
19:48:23.684 localhost-0: 19:48:23.628         Block lba: 0xf0b90000; sector lba: 0xf0b90000; Key block size: 32768; relative sector in data block: 0x00 ( 0)
19:48:23.684 localhost-0: 19:48:23.682 0x000   00000000 f0b90000 ........ ........   00000000 f0b90000 00000184 d2aa20f2
19:48:23.684 localhost-0: 19:48:23.682 0x010   01..0000 20316473 20202020 00000000   7e130000 20316473 20202020 00128706
19:48:23.684 localhost-0: 19:48:23.682         There are no mismatches in bytes 32-511

19:48:23.688 localhost-0: 19:48:23.688 op: read   lun: /dev/sdf                       lba:   4038656000 0xF0B90000 xfer:    32768 errno: 60003: '60003            A Data Validation error was discovered'
19:48:23.901 localhost-1: Writing Data Validation map to /root/vdbench/zyx2_journal/sd2.jnl
19:48:23.902 localhost-2: Writing Data Validation map to /root/vdbench/zyx2_journal/sd3.jnl
19:48:24.003 localhost-1: Writing Data Validation map to /root/vdbench/zyx2_journal/sd2.map
19:48:24.004 localhost-2: Writing Data Validation map to /root/vdbench/zyx2_journal/sd3.map
```

```
I1201 18:31:15.420491 27615 meta.cc:1616] [LIBMETA ADDR UPDATE]  old meta ip: 10.3.0.77 old meta port: 10100 new meta ip: 10.3.0.77 new meta port: 10100
W1201 18:31:15.420614 27615 event_loop.cc:168] del non-existing event for fd 17
W1201 18:31:15.420635 27615 event_loop.cc:176]  [SYSCALL]: ::epoll_ctl(efd_, EPOLL_CTL_DEL, fd, nullptr). [ARG LIST]: fd: 17 .[SYSMSG]: No such file or directory [2].
I1201 18:31:15.420702 27615 proto_async_client.h:171] Connect to 0.0.0.0:0-->10.3.0.77:10100 with timeout_ms 200
I1201 18:31:15.420825 27615 proto_async_client.h:357] Connected to 10.3.0.77:60740-->10.3.0.77:10100
I1201 18:31:15.421175 27615 connection.cc:769] Connection: 0x55a614b8e500 is to be redirected to 172.3.0.76:3261, initiator iqn: iqn.2012-01.com.openeuler:a87ffab5387c, initiator addr: 172.3.0.4, target: iqn.2016-02.com.smartx:system:target4, connection info: 172.3.0.18:3260-->172.3.0.4:38596
I1201 18:31:15.421270 27615 connection.cc:769] Connection: 0x55a614b8e780 is to be redirected to 172.3.0.76:3261, initiator iqn: iqn.2012-01.com.openeuler:a87ffab5387c, initiator addr: 172.3.0.4, target: iqn.2016-02.com.smartx:system:target3, connection info: 172.3.0.18:3260-->172.3.0.4:38598
I1201 18:31:15.814954 27615 meta_client.cc:146] Entering meta op for retry, co: 0x55a614b7eea0
I1201 18:31:15.815469 27615 connection.cc:769] Connection: 0x55a614b8e280 is to be redirected to 172.3.0.77:3261, initiator iqn: iqn.2012-01.com.openeuler:a87ffab5387c, initiator addr: 172.3.0.4, target: iqn.2016-02.com.smartx:system:target1, connection info: 172.3.0.18:3260-->172.3.0.4:38594
```
