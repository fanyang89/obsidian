```
(gdb) info threads
  Id   Target Id                     Frame
  1    LWP 1405013 "zbs-taskd"       0x0000fffda01968c8 in nanosleep () from /lib64/libc.so.6
  2    LWP 1405036 "zbs-taskd-ust"   0x0000fffda01c12d0 in syscall () from /lib64/libc.so.6
  3    LWP 1405054 "MetricCenterThr" 0x0000fffda01c5234 in epoll_pwait () from /lib64/libc.so.6
* 4    LWP 1405057 "zbs-taskd"       0x0000fffda118e5a0 in pthread_cond_wait () from /lib64/libpthread.so.0
  5    LWP 1405058 "task-main"       0x0000fffda118e5a0 in pthread_cond_wait () from /lib64/libpthread.so.0
  6    LWP 1405060 "zbs-vip-server"  0x0000fffda01968c8 in nanosleep () from /lib64/libc.so.6
```

```
(gdb) thread 5
[Switching to thread 5 (LWP 1405058)]
#0  0x0000fffda118e5a0 in pthread_cond_wait () from /lib64/libpthread.so.0

(gdb) bt
#0  0x0000fffda118e5a0 in pthread_cond_wait () from /lib64/libpthread.so.0
#1  0x0000fffda04379c0 in std::condition_variable::wait(std::unique_lock<std::mutex>&) () from /lib64/libstdc++.so.6
#2  0x0000aaaba39a83f4 in std::condition_variable::wait<zbs::Sync::WaitAndReset()::{lambda()#1}>(std::unique_lock<std::mutex>&, zbs::Sync::WaitAndReset()::{lambda()#1}) (__p=..., __lock=..., this=0xaaaba9d5f848) at /usr/include/c++/7.3.0/condition_variable:105
#3  zbs::Sync::WaitAndReset (this=0xaaaba9d5f7a0) at src/common/closure.h:66
#4  zbs::task::TaskServer::StopVIPServer (this=this@entry=0xaaaba98dc000) at src/task/task_server.cc:283
#5  0x0000aaaba39a9244 in zbs::task::TaskServer::StopService (this=0xaaaba98dc000) at src/task/task_server.cc:124
#6  0x0000aaaba3a057cc in zbs::consensus::QuorumServer::OnStatusChange (this=0xaaaba98dc000, event=zbs::consensus::QuorumClusterEvent::STOPPED) at src/consensus/quorum_server.cc:83
#7  0x0000aaaba39fbf20 in std::function<void (zbs::consensus::QuorumClusterEvent)>::operator()(zbs::consensus::QuorumClusterEvent) const (__args#0=<optimized out>, this=0xaaaba98dc3a0) at /usr/include/c++/7.3.0/bits/std_function.h:706
#8  zbs::consensus::QuorumCluster::OnEvent (event=zbs::consensus::QuorumClusterEvent::STOPPED, this=0xaaaba98dc038) at src/consensus/quorum_cluster.cc:271
#9  zbs::consensus::QuorumCluster::<lambda(zbs::consensus::QuorumClusterEvent)>::operator() (event=zbs::consensus::QuorumClusterEvent::STOPPED, __closure=<optimized out>) at src/consensus/quorum_cluster.cc:90
#10 std::_Function_handler<void(const zbs::consensus::QuorumClusterEvent&), zbs::consensus::QuorumCluster::QuorumCluster(const string&, const string&, zbs::ThreadContext*)::<lambda(zbs::consensus::QuorumClusterEvent)> >::_M_invoke(const std::_Any_data &, const zbs::consensus::QuorumClusterEvent &) (__functor=..., __args#0=<optimized out>) at /usr/include/c++/7.3.0/bits/std_function.h:316
#11 0x0000aaaba3c34664 in zbs::CoFunc::run_and_reset (this=0xaaaba9570cc0) at src/common/coroutine.h:312
#12 zbs::Coroutine::LoopMain (this=0xaaaba9570b40) at src/common/coroutine.cc:598
#13 0x0000aaaba3c346cc in zbs::Coroutine::s_co_main (lo=<optimized out>, hi=<optimized out>) at src/common/coroutine.cc:585
```

```
(gdb) thread 6
[Switching to thread 6 (LWP 1405060)]
#0  0x0000fffda01968c8 in nanosleep () from /lib64/libc.so.6

(gdb) bt
#0  0x0000fffda01968c8 in nanosleep () from /lib64/libc.so.6
#1  0x0000fffda01beaa8 in usleep () from /lib64/libc.so.6
#2  0x0000aaaba3a04cd4 in zbs::consensus::QuorumServer::Stop (this=0xaaaba98dc000, ec=...) at src/consensus/quorum_server.cc:42
#3  0x0000aaaba39add0c in std::function<void (zbs::Status const&)>::operator()(zbs::Status const&) const (__args#0=..., this=0xaaaba963cac0) at /usr/include/c++/7.3.0/bits/std_function.h:706
#4  zbs::task::VIPServer::CheckSecondaryDataChannel (this=this@entry=0xaaaba963c9a0) at src/task/tasks/task_vip_service.cc:506
#5  0x0000aaaba39b07d8 in zbs::task::VIPServer::CheckSecondaryDataChannel (this=0xaaaba963c9a0) at src/task/tasks/task_vip_service.cc:489
#6  zbs::task::VIPServer::CheckVIP (this=0xaaaba963c9a0) at src/task/tasks/task_vip_service.cc:438
#7  0x0000aaaba3c65310 in std::function<void ()>::operator()() const (this=0xaaabaa274198) at /usr/include/c++/7.3.0/bits/std_function.h:706
#8  zbs::TimerHandle::Impl::Routine(std::function<void ()> const&) (this=0xaaaba957a880, func=...) at src/common/timer_handle.cc:103
#9  0x0000aaaba3c6546c in zbs::TimerHandle::Impl::<lambda()>::operator() (__closure=<optimized out>) at src/common/timer_handle.cc:42
#10 zbs::CoFunc::Impl<zbs::TimerHandle::Impl::Impl(zbs::CoroutineScheduler*, const func_t&, uint64_t, bool, std::__cxx11::string)::<lambda()> >::s_run_and_reset(zbs::CoFunc::storage_t &) (storage=...) at src/common/coroutine.h:276
#11 0x0000aaaba3c34664 in zbs::CoFunc::run_and_reset (this=0xaaabaa274180) at src/common/coroutine.h:312
#12 zbs::Coroutine::LoopMain (this=0xaaabaa274000) at src/common/coroutine.cc:598
#13 0x0000aaaba3c346cc in zbs::Coroutine::s_co_main (lo=<optimized out>, hi=<optimized out>) at src/common/coroutine.cc:585
```

```c++
void TaskServer::BootVIPServer() {
    vip_server_.reset(new VIPServer(GetZk(), vip_server_thctx_->loop()));
    Callable on_error = BIND(&TaskServer::ErrorExit, this);
    Status st = vip_server_->Initialize(on_error, [=](const Status& status) {
        Stop(status);
    });
    if (!st.ok()) {
        LOG(ERROR) << "Init VIP server failed! exit! " << st.str();
        ErrorExit();
    }
}
```

```c++
void VIPServer::CheckSecondaryDataChannel() {
    if (session_in_check_) {
        return;
    }
    session_in_check_ = true;
    bool retried = false;
    if (!session_client_) {
        (void)CreateSessionClient();
    }

  retry:
    if (session_client_) {
        std::vector<consensus::Session> sessions;
        if (session_client_->ListSession(kAccessSessionGroup,
                                         &sessions).ok()) {
            if (!IfSecDataChannelHeathy(sessions)) {
                LOG(INFO) << "Local secondary data channel was invalid, restart.";
                CleanVIP();
                on_unhealthy_(Status(EDataChannelManager));
            }
        } else {
            if (!retried) {
                retried = true;
                if (CreateSessionClient()) goto retry;
            }
            LOG(ERROR) << "Unable to list sessions";
        }
    } else {
        LOG(ERROR) << "Unable to refersh session client";
        session_in_check_ = false;
        return;
    }
    session_in_check_ = false;
}
```

当 Secondary DataChannel 不健康时，on*unhealthy*() -> Stop(status)，于是

```c++
void QuorumServer::Stop(const Status& ec) {
    LOG(INFO) << "Quorum server begins stopping, this: " << this;
    CHECK(gettid() != thctx_->GetTid()) << "current tid: " << gettid() << " quorum tid: " << thctx_->GetTid();
    mutex_.Lock();
    exit_status_ = ec;
    mutex_.Unlock();
    quorum_cluster_.NotifyStop();
    while (!IsStopped()) {
        LOG(INFO) << "Wait for quorum server to stop, this:" << this;
        usleep(1'000'000);
    }
    LOG(INFO) << "Quorum server has stopped, this:" << this;
}
```

vip server -> notify QuorumServer 进行 Stop
