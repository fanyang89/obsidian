```c++
p *this
$16 = {<google::protobuf::Message> = {<No data fields>}, static kIdFieldNumber = 1, static kV1ParentIdFieldNumber = 2, static kDataIpFieldNumber = 12, static kDataPortFieldNumber = 13,
  static kRpcIpFieldNumber = 14, static kRpcPortFieldNumber = 15, static kHeartbeatIpFieldNumber = 16, static kHeartbeatPortFieldNumber = 17, static kRegisteredDateFieldNumber = 18,
  static kStatusFieldNumber = 21, static kSpaceInfoFieldNumber = 22, static kReadPerfFieldNumber = 23, static kWritePerfFieldNumber = 24, static kUseStateFieldNumber = 25, static kTotalPerfFieldNumber = 26,
  static kCrossZoneReadPerfFieldNumber = 27, static kCrossZoneWritePerfFieldNumber = 28, static kIpmiIpFieldNumber = 31, static kTopoIdFieldNumber = 41, static kZoneIdFieldNumber = 42,
  static kStoragePoolIdFieldNumber = 45, static kLastSucceedHeartbeatFieldNumber = 51, static kNodePerfFieldNumber = 52, static kRecoverInfoFieldNumber = 53, static kHostNameFieldNumber = 54,
  static kLsmVersionFieldNumber = 55, static kMaintenanceModeFieldNumber = 56, static kMaintenanceModeExpireTimeSFieldNumber = 58, static kChunkPerfFieldNumber = 59, static kHasConfigPushAbilityFieldNumber = 57,
  _unknown_fields_ = {fields_ = 0x0}, id_ = 1, v1_parent_id_ = 0, data_ip_ = 40133732, data_port_ = 10201, rpc_ip_ = 40133732, rpc_port_ = 10200, heartbeat_ip_ = 0, heartbeat_port_ = 0, registered_date_ = 0,
  space_info_ = 0x0, status_ = 1, use_state_ = 0, read_perf_ = 0xfffc0000, write_perf_ = 0x0, total_perf_ = 0x0, cross_zone_read_perf_ = 0x0, cross_zone_write_perf_ = 0x0,
  ipmi_ip_ = 0x7f7135f8b1a8 <google::protobuf::internal::kEmptyString>, topo_id_ = 0x7f7135f8b1a8 <google::protobuf::internal::kEmptyString>, zone_id_ = 0x5630a88f3ef0,
  storage_pool_id_ = 0x7f7135f8b1a8 <google::protobuf::internal::kEmptyString>, last_succeed_heartbeat_ = 0, node_perf_ = 0x0, recover_info_ = 0x0,
  host_name_ = 0x7f7135f8b1a8 <google::protobuf::internal::kEmptyString>, lsm_version_ = 0x0, maintenance_mode_expire_time_s_ = 0, chunk_perf_ = 0x0, maintenance_mode_ = false, has_config_push_ability_ = false,
  _cached_size_ = 0, _has_bits_ = {524349}, static default_instance_ = 0x56304b520000}
```

```c++
(gdb) f 25
#25 zbs::libmeta::Meta::ClearExpiredLease (this=this@entry=0x56304b54ca00) at src/libmeta/meta.cc:3110
3110	src/libmeta/meta.cc: No such file or directory.
(gdb) p this->chunks_[1]
$18 = {<google::protobuf::Message> = {<No data fields>}, static kIdFieldNumber = 1, static kV1ParentIdFieldNumber = 2, static kDataIpFieldNumber = 12, static kDataPortFieldNumber = 13,
  static kRpcIpFieldNumber = 14, static kRpcPortFieldNumber = 15, static kHeartbeatIpFieldNumber = 16, static kHeartbeatPortFieldNumber = 17, static kRegisteredDateFieldNumber = 18,
  static kStatusFieldNumber = 21, static kSpaceInfoFieldNumber = 22, static kReadPerfFieldNumber = 23, static kWritePerfFieldNumber = 24, static kUseStateFieldNumber = 25, static kTotalPerfFieldNumber = 26,
  static kCrossZoneReadPerfFieldNumber = 27, static kCrossZoneWritePerfFieldNumber = 28, static kIpmiIpFieldNumber = 31, static kTopoIdFieldNumber = 41, static kZoneIdFieldNumber = 42,
  static kStoragePoolIdFieldNumber = 45, static kLastSucceedHeartbeatFieldNumber = 51, static kNodePerfFieldNumber = 52, static kRecoverInfoFieldNumber = 53, static kHostNameFieldNumber = 54,
  static kLsmVersionFieldNumber = 55, static kMaintenanceModeFieldNumber = 56, static kMaintenanceModeExpireTimeSFieldNumber = 58, static kChunkPerfFieldNumber = 59, static kHasConfigPushAbilityFieldNumber = 57,
  _unknown_fields_ = {fields_ = 0x0}, id_ = 1, v1_parent_id_ = 0, data_ip_ = 40133732, data_port_ = 10201, rpc_ip_ = 40133732, rpc_port_ = 10200, heartbeat_ip_ = 0, heartbeat_port_ = 0, registered_date_ = 0,
  space_info_ = 0x0, status_ = 1, use_state_ = 0, read_perf_ = 0x0, write_perf_ = 0x0, total_perf_ = 0x0, cross_zone_read_perf_ = 0x0, cross_zone_write_perf_ = 0x0,
  ipmi_ip_ = 0x7f7135f8b1a8 <google::protobuf::internal::kEmptyString>, topo_id_ = 0x7f7135f8b1a8 <google::protobuf::internal::kEmptyString>, zone_id_ = 0x56304bd4f1f0,
  storage_pool_id_ = 0x7f7135f8b1a8 <google::protobuf::internal::kEmptyString>, last_succeed_heartbeat_ = 0, node_perf_ = 0x0, recover_info_ = 0x0,
  host_name_ = 0x7f7135f8b1a8 <google::protobuf::internal::kEmptyString>, lsm_version_ = 0x0, maintenance_mode_expire_time_s_ = 0, chunk_perf_ = 0x0, maintenance_mode_ = false, has_config_push_ability_ = false,
  _cached_size_ = 0, _has_bits_ = {524349}, static default_instance_ = 0x56304b520000}
```

那么，谁能访问到 vextent*leases* 中的 Lease 中的 chunks？
RefreshChildExtentLocation，获取了 lease 的指针

CacheVExtentLease 把 lease 塞进 vextent*leases*

```
Mapped address spaces:

          Start Addr           End Addr       Size     Offset objfile
      0x563048ca7000     0x563049373000   0x6cc000        0x0 /usr/sbin/zbs-chunkd
      0x563049572000     0x563049595000    0x23000   0x6cb000 /usr/sbin/zbs-chunkd
      0x563049595000     0x563049597000     0x2000   0x6ee000 /usr/sbin/zbs-chunkd


(gdb) find 0x563048ca7000,0x563049373000,0xfffc0000
0x563048e9f902 <_ZN3zbs5chunk3lsm3LSM7StartIOEPNS_10ControllerEPKNS0_10lsm_args_tE+82>
0x563048e9f90e <_ZN3zbs5chunk3lsm3LSM7StartIOEPNS_10ControllerEPKNS0_10lsm_args_tE+94>
0x563048f5f21e <_ZN3zbs5chunk4lsm211PBlobLoader10LoadPBlobsEv+110>
0x56304933d33a
warning: Unable to access 12355 bytes of target memory at 0x56304936ffbe, halting search.
4 patterns found.

find 0x563049572000,0x563049595000,0xfffc0000
find 0x563049595000,0x563049597000,0xfffc0000

x /g 0x56304933d33a
0x56304933d33a:	0x41300006fffc0000

find 0x563048ca7000,0x563049373000,0x56304933d33a

find 0x563048ca7000,0x563049372fff,0xfffc0000

(gdb) find 0x563048ca7000,0x563049372fff,0xfffc0000
0x563048e9f902 <_ZN3zbs5chunk3lsm3LSM7StartIOEPNS_10ControllerEPKNS0_10lsm_args_tE+82>
0x563048e9f90e <_ZN3zbs5chunk3lsm3LSM7StartIOEPNS_10ControllerEPKNS0_10lsm_args_tE+94>
0x563048f5f21e <_ZN3zbs5chunk4lsm211PBlobLoader10LoadPBlobsEv+110>
0x56304933d33a
4 patterns found.

x 0x56304933d33a
0x56304933d33a:	0x41300006 fffc0000
```

```
(gdb) p *this
$69 = {<google::protobuf::Message> = {<No data fields>}, static kIdFieldNumber = 1, static kV1ParentIdFieldNumber = 2, static kDataIpFieldNumber = 12, static kDataPortFieldNumber = 13,
  static kRpcIpFieldNumber = 14, static kRpcPortFieldNumber = 15, static kHeartbeatIpFieldNumber = 16, static kHeartbeatPortFieldNumber = 17, static kRegisteredDateFieldNumber = 18,
  static kStatusFieldNumber = 21, static kSpaceInfoFieldNumber = 22, static kReadPerfFieldNumber = 23, static kWritePerfFieldNumber = 24, static kUseStateFieldNumber = 25, static kTotalPerfFieldNumber = 26,
  static kCrossZoneReadPerfFieldNumber = 27, static kCrossZoneWritePerfFieldNumber = 28, static kIpmiIpFieldNumber = 31, static kTopoIdFieldNumber = 41, static kZoneIdFieldNumber = 42,
  static kStoragePoolIdFieldNumber = 45, static kLastSucceedHeartbeatFieldNumber = 51, static kNodePerfFieldNumber = 52, static kRecoverInfoFieldNumber = 53, static kHostNameFieldNumber = 54,
  static kLsmVersionFieldNumber = 55, static kMaintenanceModeFieldNumber = 56, static kMaintenanceModeExpireTimeSFieldNumber = 58, static kChunkPerfFieldNumber = 59, static kHasConfigPushAbilityFieldNumber = 57,
  _unknown_fields_ = {fields_ = 0x0}, id_ = 1, v1_parent_id_ = 0, data_ip_ = 40133732, data_port_ = 10201, rpc_ip_ = 40133732, rpc_port_ = 10200, heartbeat_ip_ = 0, heartbeat_port_ = 0, registered_date_ = 0,
  space_info_ = 0x0, status_ = 1, use_state_ = 0, read_perf_ = 0xfffc0000, write_perf_ = 0x0, total_perf_ = 0x0, cross_zone_read_perf_ = 0x0, cross_zone_write_perf_ = 0x0,
  ipmi_ip_ = 0x7f7135f8b1a8 <google::protobuf::internal::kEmptyString>, topo_id_ = 0x7f7135f8b1a8 <google::protobuf::internal::kEmptyString>, zone_id_ = 0x5630a88f3ef0,
  storage_pool_id_ = 0x7f7135f8b1a8 <google::protobuf::internal::kEmptyString>, last_succeed_heartbeat_ = 0, node_perf_ = 0x0, recover_info_ = 0x0,
  host_name_ = 0x7f7135f8b1a8 <google::protobuf::internal::kEmptyString>, lsm_version_ = 0x0, maintenance_mode_expire_time_s_ = 0, chunk_perf_ = 0x0, maintenance_mode_ = false, has_config_push_ability_ = false,
  _cached_size_ = 0, _has_bits_ = {524349}, static default_instance_ = 0x56304b520000}
```

```
(gdb) f 12
#12 0x0000563048dfe9c4 in zbs::libmeta::CachedLease::~CachedLease (this=0x5630c6e682d0, __in_chrg=<optimized out>) at src/libmeta/meta.h:84
84	src/libmeta/meta.h: No such file or directory.
(gdb) p *this
$71 = {<zbs::Lease> = {<google::protobuf::Message> = {<No data fields>}, static kOwnerFieldNumber = 1, static kPidFieldNumber = 10, static kLocationFieldNumber = 11, static kOriginPidFieldNumber = 12,
    static kEpochFieldNumber = 13, static kOriginEpochFieldNumber = 14, static kEverExistFieldNumber = 15, static kMetaGenerationFieldNumber = 16, static kExpectedReplicaNumFieldNumber = 17,
    static kChunksFieldNumber = 30, _unknown_fields_ = {fields_ = 0x0}, owner_ = 0x5630a3a117f0, pid_ = 247910, location_ = 262402, epoch_ = 251051, origin_pid_ = 0, ever_exist_ = true, origin_epoch_ = 0,
    meta_generation_ = 8, chunks_ = {<google::protobuf::internal::RepeatedPtrFieldBase> = {static kInitialSize = 0, elements_ = 0x56306e31fac0, current_size_ = 4, allocated_size_ = 4,
        total_size_ = 4}, <No data fields>}, expected_replica_num_ = 3, _cached_size_ = 0, _has_bits_ = {511},
    static default_instance_ = 0x56304b524b60}, <zbs::RefCounted<zbs::libmeta::CachedLease, false>> = {<zbs::subtle::RefCountedBase<false>> = {ref_count_ = 0}, <No data fields>}, expired_ = true, cow_ = true,
  io_hard_ = false, gen_ = 8, last_access_ = 6105691, staging_block_info_ = std::unique_ptr<zbs::libmeta::StagingBlockInfo> = {get() = 0x0}}
```

## 问题版本

- zbs-4.0.12-rc1

# 售后系统

- https://cs.smartx.com/cases/detail?id=1032815
- https://cs.smartx.com/cases/detail?id=1032902
- https://cs.smartx.com/cases/detail?id=1033211
  共同点：版本是 4.0.12-rc1
  根据搜索，对应 ISO 为 4.0.12

zbs-4.0.11-rc19.0.release.git.gfd4159884.el7.SMTX.hygon.HCI.x86_64 开始存在此问题

```
uint64_t zone_offset = ROUND_DOWN(uioctx->offset, FLAGS_seq_io_zone_size);
GUOffset guos = { uioctx->volume_id, zone_offset };
auto iter = zone_ctx_map_.find(guos);

p io_ctx->uioctx->volume_id
$2 = 0x0943248814a7fe844d4518dae41eb6f2

(gdb) p io_ctx->uioctx->offset
$3 = 3886546944
```
