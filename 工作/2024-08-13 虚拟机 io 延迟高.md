## 故障时间点

- 2024-08-12T13:19:46
- 0812 13:19:46

## 原始问题

`Dogfood-SMTXOS-61x-17.99-MLAG`（非 Boost 模式）这个集群在升级过程中，SFS VM 内部的 etcd 的延迟观察到有两个时间点为 50s+ 的延迟。时间分别为：
SFS VM: 192.168.20.81, host IP: 192.168.17.104

```
etcd container id: 3508ee845b7e \"ts\":\"2024-08-12T13:19:51.002345+0800\"\"took\":\"57.349905891s\"
```

SFS VM: 192.168.20.82, host IP: 192.168.19.85

```
etcd container id: 8cfde50874df \"ts\":\"2024-08-12T13:19:46.088895+0800\"\"took\":\"53.311940411s\"
```

tower 监控上看，SFS VM 的系统盘 `sfs-4f93fca6-1b8d-4bbb-99e8...3d96a9b-1-volume-1`（pinssd）的平均延迟也高达 7s+。
sfs 对磁盘的监控服务此时间段异常，所以没有数据。
这个看起来跟 ZBS 的故障中断时间是不符的，帮忙确认一下

## 日志

```
# 17.99
E0812 13:18:51.233381 13733 main.cc:83] [ZOO] handle_socket_error_msg:2661 2024-08-12 13:18:51,233 13642(0x7fcad2d6e700) ERR handle_socket_error_msg:2661] Socket [10.255.0.99:2181] zk retcode=-4, errno=104(Connection reset by peer): failed while receiving a server response
```

![[b91a4c9853e2dd0a60005ee7dcfd9b851c5d28a9c1dd08fec85de507039ce123d593477a092a87d42274e4d7e919cae7e87e2b22b90a6f35e29e0e8b75ec81c2.png]]

![[546e98f535d503af26057d54ea0e57677e96c9682f621a684991bf6789b8ad4ffc34b9e34b22bf9e86adae5e8cf21c409c8907e95b0d2042c29a6b0d8b1dac3e.png]]

![[22a984c03256dbf10d9328d8418debabd023c8da2d96b160e8b6f5c474f911611a8615e8705b0e350e7b85960584710f8476d255c5fba34e40dcf7f9e82a699f.png]]

## 检查选举

### 节点 19.41

在 `13:18:56` 时重新启动

```
2024-08-12T13:18:50,175 [myid:] - INFO  [NIOWorkerThread-1:NIOServerCnxn@518] - Processing stat command from /10.255.0.99:56852
2024-08-12T13:18:50,175 [myid:] - INFO  [NIOWorkerThread-1:StatCommand@53] - Stat command output
2024-08-12T13:18:50,183 [myid:] - INFO  [NIOWorkerThread-2:QuorumZooKeeperServer@157] - Submitting global closeSession request for session 0xb0030406dcab1bd
2024-08-12T13:18:56,289 [myid:] - INFO  [main:QuorumPeerConfig@137] - Reading configuration from: /etc/zookeeper/zoo.cfg
2024-08-12T13:18:56,320 [myid:] - INFO  [main:QuorumPeerConfig@381] - clientPort is not set
```

### 节点 19.85

在 `13:18:18` 时重新启动

```
2024-08-12T13:18:11,830 [myid:] - INFO  [CommitProcWorkThread-1:LearnerSessionTracker@122] - Committing global session 0x8004069c13e002f
2024-08-12T13:18:18,130 [myid:] - INFO  [main:QuorumPeerConfig@137] - Reading configuration from: /etc/zookeeper/zoo.cfg
2024-08-12T13:18:18,222 [myid:10] - INFO  [main:FileSnap@84] - Reading snapshot /var/lib/zbs/metad/zookeeper/version-2/snapshot.151001ff2c0
2024-08-12T13:18:20,746 [myid:] - INFO  [main:QuorumPeerConfig@137] - Reading configuration from: /etc/zookeeper/zoo.cfg
```
