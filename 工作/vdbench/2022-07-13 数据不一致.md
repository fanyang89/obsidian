# 环境

node1: 192.168.75.119 10.243.28.246 192.168.75.122 (vm1)  
node2: 192.168.75.120 10.243.28.247 192.168.78.209 (vm2)  
node3: 192.168.76.82 10.243.28.248 192.168.75.121 (vm3)

# 操作

所有 VM 分别挂载三块磁盘，vdbench 做磁盘读写

```
data_errors=1
hd=default,vdbench=/root/vdbench,shell=ssh,user=root
sd=default,openflags=o_direct,size=5G,threads=32,journal=/root/vdbench/zyx1_journal
sd=sd1,lun=/dev/sda
sd=sd2,lun=/dev/sdb
sd=sd3,lun=/dev/vdb
wd=default,xfersize=(32k,20,64k,10,128k,30,256k,40)
wd=wd1,sd=sd1,seekpct=100
wd=wd2,sd=sd2,seekpct=100
wd=wd3,sd=sd3,seekpct=100
rd=default,iorate=max,elapsed=72000,interval=1,warmup=30,pause=10
rd=rd1,wd=wd*,rdpct=0
```

```
virtio-blk-pci,scsi=off,bus=pci.0,addr=0xc,drive=drive-virtio-disk1,id=virtio-disk1,bootindex=3,write-cache=on

file.driver=iscsi,file.portal=127.0.0.1:3260,file.target=iqn.2016-02.com.smartx:system:zbs-iscsi-datastore-1657625497777y,file.lun=232,file.transport=tcp,file.initiator-name=iqn.2013-11.org.smartx:b0f7698d-c505-4115-9c5a-867e9a390d76.9e5ef09a-01cd-11ed-820a-525400456b85.0,format=raw,if=none,id=drive-virtio-disk1,serial=5acb9a9c-a83d-3416-afcf-879c525c6da4,cache=none,aio=native

$ zbs-iscsi lun show zbs-iscsi-datastore-1657625497777y 232
------------------  --------------------------------------------------------------------------------------------------
LUN Id              232
LUN Name            2b2bb6ef-6ace-4ac4-936e-0aa9c1dacf22
Size                25.00 GB
Unique Size         0.00 B
Shared Size         5.00 GB
Volume id           90184759-9dcb-4556-a8ef-9d13908eb70b
Replica Num         2
Creation Time       2022-07-12 19:31:37.927836311
Description
NAA                 3354dbcdbd9574810
Allowed Initiators  iqn.2013-11.org.smartx:b0f7698d-c505-4115-9c5a-867e9a390d76.9e5ef09a-01cd-11ed-820a-525400456b85.0
Single Access       True
PR                  Details
------------------  --------------------------------------------------------------------------------------------------
```

![](assets/Pasted%20image%2020220713192341.png)

1. node1 注入数据网故障（ifdown 1min, ifup 5min）metad 和 chunkd 服务故障（stop 1min, start 5min），使用脚本故障执行 100 次。业务正常（持续 10h），node1 出现 core, yanglang 在定位
2. 停掉故障，node1 做网络重启故障，systemctl restart network

vm1 的业务出现校验失败，vm2 和 vm3 的业务仍然正常（持续 14h）
在 chunk 加入了 `CHUNK_IO_VERIFY_MODE=crash` 后，在 node1 发现了数据不一致

在独立 zbs 上测试了一下相同场景，没有出现校验失败

问题：

1. vdbench 如何工作？如何确认数据是否已经写入成功？zbs 做的保证是，如果 directio 成功返回，那么写入就是成功的。
2. 对于一个嵌套的 zbs 来说，如何写入才算是真正的写入成功？

不论是否嵌套，如果保证的程度到“directio 成功返回就是写入成功”，那么这种场景下 zbs 的写入可能存在问题。
首先要做的事情还是定性，问题到底出在哪一步？

# vdbench data validation

Data validation works as follows: Every write operation against an SD or FSD will be recorded in an in-memory table.
Each 512-byte sector in the block that is written contains an 8-byte logical byte address (LBA), and a one-byte data validation key.

The data validation key is incremented from `1` to `126` for each write to the same block. Once it reaches the value `126`, it will roll over to one. Zero is an internal value indicating that the block has never been written.
This key methodology is developed to identify lost writes. If the same block is written several times without changing the contents of the block it is impossible to recognize if one or more of the writes have been lost. Using this key methodology we will have to lose exactly `126` consecutive writes to the same block without being able to identify that writes were lost.

After a block has been written once, the data in the block will be validated after each read operation. A write will always be prefixed by a read so that the original content can be validated. Use of the `'-vr'` execution parameter (or `validate=read` parameter file option) forces each block to be read immediately after it has been written.
However, remember that there is no guarantee that the data has correctly reached the physical disk drive; the data could have been simply read from cache.

## Note: starting vdbench50407 the Data Validation key no longer always starts with ‘1’. That is a very important change. Why?

You start a test, writing a block starting with key=1. This write is lost. When you read it you can end up finding YESTERDAY’s contents of this block and therefore not recognizing a corruption. By starting the key of each block with a random value we virtually guarantee that a corruption like this will be recognized.
Yes, there of course still is a one in 126 chance that in consecutive tests the randomizer generates the same starting key value for the same key block, but still that is better than always starting with the same key.
The Dedup flipflop mechanism for duplicate blocks also will start with a random key, and only the last bit will be flipped (an even to odd to even flip).

# day 1

```bash
14:58:38.804 14:58:38.760 14:58:38.745 Time of first corruption: 星期三 七月 13 2022 14:58:38.745 CST
14:58:39.589 14:58:39.571 14:58:38.761 Corrupted data block for sd=sd3,lun=/dev/vdb; lba: 1,861,222,400 (0x6ef00000) xfersize=262144

14:58:39.589 14:58:39.571 14:58:38.761 Data block has 8 key block(s) of 32768 bytes each.
14:58:39.589 14:58:39.571 14:58:38.761 4 of 8 key blocks are corrupted.

# 一个 256k 的 block 里有 8 个 key block，4 个 key block 损坏。

14:58:39.589 14:58:39.571 14:58:38.762 Key block lba: 0x6ef00000
14:58:39.589 14:58:39.571 14:58:38.762    Key block of 32,768 bytes has 64 512-byte sectors. # 32k block 里有 64 个 sector
14:58:39.589 14:58:39.571 14:58:38.762    Timeline:
14:58:39.589 14:58:39.571 14:58:38.818    星期三 七月 13 2022 14:57:53.426 CST Sector last written. (As found in the first corrupted sector, timestamp is taken just BEFORE the actual write).
14:58:39.589 14:58:39.571 14:58:38.836    星期三 七月 13 2022 14:58:38.158 CST Key block first found to be corrupted during a read-before-write.
14:58:39.589 14:58:39.571 14:58:38.836
14:58:39.589 14:58:39.571 14:58:38.837    All 64 sectors in this key block are corrupted.
14:58:39.589 14:58:39.571 14:58:38.837    All corruptions are of the same type:
14:58:39.589 14:58:39.571 14:58:38.837    ===> Data Validation Key miscompare. Expecting key=0x57 received key=0x56 (87/86)
14:58:39.589 14:58:39.571 14:58:38.837    Only the FIRST sector will be reported:
14:58:39.589 14:58:39.571 14:58:38.837
14:58:39.589 14:58:39.571 14:58:38.837         Data Validation error for sd=sd3,lun=/dev/vdb
14:58:39.589 14:58:39.571 14:58:38.837         Block lba: 0x6ef00000; sector lba: 0x6ef00000; Key block size: 32768; relative sector in data block: 0x00 ( 0)
14:58:39.589 14:58:39.571 14:58:39.570 0x000   00000000 6ef00000 ........ ........   00000000 6ef00000 00000181 f6598f12
14:58:39.589 14:58:39.571 14:58:39.570 0x010   57..0000 20336473 20202020 00000000   56720000 20336473 20202020 00005e5a
14:58:39.589 14:58:39.571 14:58:39.570         There are no mismatches in bytes 32-511
```

```bash
# 丢失范围：一个 128k，从 0x6ef00000~0x6ef18000, pid=1719, extent 的第 755 个 block extent_offset = 755 * 256k = 0xbcc0000 = 197918720
```

```
# node1 timemachine
2022/07/13 14:58:32 conn.go:126: net dial error: dial tcp 10.243.28.246:10600: connect: connection refused
2022/07/13 14:58:32 conn.go:126: net dial error: dial tcp 10.243.28.246:10600: connect: connection refused
2022/07/13 14:58:35 conn.go:126: net dial error: dial tcp 10.243.28.246:10600: connect: connection refused
2022/07/13 14:58:35 conn.go:126: net dial error: dial tcp 10.243.28.246:10600: connect: connection refused
2022/07/13 14:58:38 conn.go:126: net dial error: dial tcp 10.243.28.246:10600: connect: connection refused
2022/07/13 14:58:38 conn.go:126: net dial error: dial tcp 10.243.28.246:10600: connect: connection refused
```

```
# node1 bash.log
[ 20220713 14:58:14 smartx   pts/0        2022-07-13 09:23   .        198477 (192.168.64.1) ] [root] 2022-07-13 14:57:52 systemctl restart network

# node1 chunk
I0713 14:57:52.377097 178607 access_io_handler.cc:806] Yield for waiting recover, pid: 1702, src: 3, dst: 1, state: WRITE, cur_block: 739  gen: 50289
I0713 14:57:53.671651 178607 access_io_handler.cc:806] Yield for waiting recover, pid: 1708, src: 3, dst: 1, state: WRITE, cur_block: 781  gen: 53237
W0713 14:57:54.972712 178607 socket_server_transport.cc:269] [NETWORK] fd 97: EPOLLRDHUP received.
I0713 14:57:54.974637 178607 data_channel_server_v2.cc:105] [DATACHANNEL SERVER] lost server_transport 0x55a0bf615680 ServerTransport with peer TCP Socket (192.168.75.120:44402) via local TCP Socket (0.0.0.0:10201)
W0713 14:57:55.866704 178607 socket_server_transport.cc:269] [NETWORK] fd 88: EPOLLRDHUP received.
I0713 14:57:55.866823 178607 data_channel_server_v2.cc:105] [DATACHANNEL SERVER] lost server_transport 0x55a0bf2ff440 ServerTransport with peer TCP Socket (10.243.28.248:39248) via local TCP Socket (0.0.0.0:10201)
W0713 14:57:56.330698 178607 socket_server_transport.cc:269] [NETWORK] fd 98: EPOLLRDHUP received.
I0713 14:57:56.330823 178607 data_channel_server_v2.cc:105] [DATACHANNEL SERVER] lost server_transport 0x55a0bf615d40 ServerTransport with peer TCP Socket (10.243.28.248:35990) via local TCP Socket (0.0.0.0:10201)
W0713 14:57:56.498672 178607 proto_async_client.h:482] EPOLLRDHUP received.
W0713 14:57:56.498836 178607 proto_async_client.h:494] Failed to recv msg: [ENIOError]
W0713 14:57:56.554703 178607 socket_server_transport.cc:269] [NETWORK] fd 95: EPOLLRDHUP received.
I0713 14:57:56.555505 178607 data_channel_server_v2.cc:105] [DATACHANNEL SERVER] lost server_transport 0x55a0bf614000 ServerTransport with peer TCP Socket (10.243.28.247:60100) via local TCP Socket (0.0.0.0:10201)
```

```
$zbs-meta chunk list
  ID  IP             Host Name      Port  Storage Pool    Use State    Link Status        Data Capacity    Used Space    Provisioned Space    Failure Data Space    Failure Cache Space    Cache Capacity    Used Cache Space    Registered Date      LSM Version    Zone     Maintenance Mode
----  -------------  -----------  ------  --------------  -----------  -----------------  ---------------  ------------  -------------------  --------------------  ---------------------  ----------------  ------------------  -------------------  -------------  -------  ------------------
   1  10.243.28.246  node1         10200  system          IN_USE       CONNECTED_HEALTHY  288.23 GB        117.75 GB     117.75 GB            0.00 B                0.00 B                 50.00 GB          44.99 GB            2022-07-12 18:43:44  2.2.1          default  False
   2  10.243.28.247  node2         10200  system          IN_USE       CONNECTED_HEALTHY  288.23 GB        141.25 GB     141.25 GB            0.00 B                0.00 B                 50.00 GB          44.98 GB            2022-07-12 18:43:44  2.2.1          default  False
   3  10.243.28.248  node3         10200  system          IN_USE       CONNECTED_HEALTHY  288.23 GB        111.50 GB     111.50 GB            0.00 B                0.00 B                 50.00 GB          33.05 GB            2022-07-12 18:43:45  2.2.1          default  False
```

```
ID                                    Name                                  Parent ID                             Pool Name                           Size        Unique Size    Shared Size    Creation Time
            Status           Replica Number  Thin Provision    Read Only    Description    Alloc Even      Clone count
------------------------------------  ------------------------------------  ------------------------------------  ----------------------------------  ----------  -------------  -------------  -------------------
----------  -------------  ----------------  ----------------  -----------  -------------  ------------  -------------
90184759-9dcb-4556-a8ef-9d13908eb70b  90184759-9dcb-4556-a8ef-9d13908eb70b  619903ef-b56c-47fc-8062-43aab5429b39  zbs-iscsi-datastore-1657625497777y  25.00 GB    0.00 B         5.00 GB        2022-07-12 19:31:37.927836311  VOLUME_ONLINE                 2  True              False                       False                     0

$zbs-meta volume show zbs-iscsi-datastore-1657625497777y 90184759-9dcb-4556-a8ef-9d13908eb70b
--------------  ------------------------------------
ID              90184759-9dcb-4556-a8ef-9d13908eb70b
Name            90184759-9dcb-4556-a8ef-9d13908eb70b
Parent ID       619903ef-b56c-47fc-8062-43aab5429b39
Size            25.00 GB
Unique Size     0.00 B
Shared Size     5.00 GB
Creation Time   2022-07-12 19:31:37.927836311
Status          VOLUME_ONLINE
Replica Number  2
Thin Provision  True
Read Only       False
Description
Alloc Even      False
Clone count     0
Iops            0
Iops Read       0
Iops Write      0
Bps             0
Bps Read        0
Bps Write       0
Stripe Num      4
Stripe Size     262144
--------------  ------------------------------------

  chunk_id    total_replica_count    alive_replica_count
----------  ---------------------  ---------------------
         1                     20                     20
         3                     20                     20


  ID  Replica    Alive Replica    Ever Exist    Is Garbage      Origin PExtent    Expected Replica num    Epoch    Prefer Local
----  ---------  ---------------  ------------  ------------  ----------------  ----------------------  -------  --------------
1732  [1, 3]     [1, 3]           True          False                     1476                       2     2115               1
1701  [1, 3]     [1, 3]           True          False                     1463                       2     2084               1
1718  [1, 3]     [1, 3]           True          False                     1470                       2     2101               1
1712  [1, 3]     [1, 3]           True          False                     1469                       2     2095               1

1719  [1, 3]     [1, 3]           True          False                     1464                       2     2102               1
1734  [1, 3]     [1, 3]           True          False                     1456                       2     2117               1
1724  [1, 3]     [1, 3]           True          False                     1455                       2     2107               1
1736  [1, 3]     [1, 3]           True          False                     1453                       2     2119               1

1717  [1, 3]     [1, 3]           True          False                     1457                       2     2100               1
1703  [1, 3]     [1, 3]           True          False                     1477                       2     2086               1
1720  [1, 3]     [1, 3]           True          False                     1479                       2     2103               1
1706  [1, 3]     [1, 3]           True          False                     1458                       2     2089               1
1741  [1, 3]     [1, 3]           True          False                     1459                       2     2124               1
1708  [1, 3]     [1, 3]           True          False                     1471                       2     2091               1
1721  [1, 3]     [1, 3]           True          False                     1466                       2     2104               1
1726  [1, 3]     [1, 3]           True          False                     1473                       2     2109               1
1710  [1, 3]     [1, 3]           True          False                     1474                       2     2093               1
1723  [1, 3]     [1, 3]           True          False                     1465                       2     2106               1
1722  [1, 3]     [1, 3]           True          False                     1467                       2     2105               1
1714  [1, 3]     [1, 3]           True          False                     1461                       2     2097               1
 421  []         []               False         False                        0                       2      457               0
 422  []         []               False         False                        0                       2      458               0
 423  []         []               False         False                        0                       2      459               0
 424  []         []               False         False                        0                       2      460               0
 425  []         []               False         False                        0                       2      461               0
 426  []         []               False         False                        0                       2      462               0
 427  []         []               False         False                        0                       2      463               0
 428  []         []               False         False                        0                       2      464               0
 429  []         []               False         False                        0                       2      465               0
 430  []         []               False         False                        0                       2      466               0
 431  []         []               False         False                        0                       2      467               0
 432  []         []               False         False                        0                       2      468               0
 433  []         []               False         False                        0                       2      469               0
 434  []         []               False         False                        0                       2      470               0
 435  []         []               False         False                        0                       2      471               0
 436  []         []               False         False                        0                       2      472               0
 437  []         []               False         False                        0                       2      473               0
 438  []         []               False         False                        0                       2      474               0
 439  []         []               False         False                        0                       2      475               0
 440  []         []               False         False                        0                       2      476               0
 441  []         []               False         False                        0                       2      477               0
 442  []         []               False         False                        0                       2      478               0
 443  []         []               False         False                        0                       2      479               0
 444  []         []               False         False                        0                       2      480               0
 445  []         []               False         False                        0                       2      481               0
 446  []         []               False         False                        0                       2      482               0
 447  []         []               False         False                        0                       2      483               0
 448  []         []               False         False                        0                       2      484               0
 449  []         []               False         False                        0                       2      485               0
 450  []         []               False         False                        0                       2      486               0
 451  []         []               False         False                        0                       2      487               0
 452  []         []               False         False                        0                       2      488               0
 453  []         []               False         False                        0                       2      489               0
 454  []         []               False         False                        0                       2      490               0
 455  []         []               False         False                        0                       2      491               0
 456  []         []               False         False                        0                       2      492               0
 457  []         []               False         False                        0                       2      493               0
 458  []         []               False         False                        0                       2      494               0
 459  []         []               False         False                        0                       2      495               0
 460  []         []               False         False                        0                       2      496               0
 461  []         []               False         False                        0                       2      497               0
 462  []         []               False         False                        0                       2      498               0
 463  []         []               False         False                        0                       2      499               0
 464  []         []               False         False                        0                       2      500               0
 465  []         []               False         False                        0                       2      501               0
 466  []         []               False         False                        0                       2      502               0
 467  []         []               False         False                        0                       2      503               0
 468  []         []               False         False                        0                       2      504               0
 469  []         []               False         False                        0                       2      505               0
 470  []         []               False         False                        0                       2      506               0
 471  []         []               False         False                        0                       2      507               0
 472  []         []               False         False                        0                       2      508               0
 473  []         []               False         False                        0                       2      509               0
 474  []         []               False         False                        0                       2      510               0
 475  []         []               False         False                        0                       2      511               0
 476  []         []               False         False                        0                       2      512               0
 477  []         []               False         False                        0                       2      513               0
 478  []         []               False         False                        0                       2      514               0
 479  []         []               False         False                        0                       2      515               0
 480  []         []               False         False                        0                       2      516               0
 481  []         []               False         False                        0                       2      517               0
 482  []         []               False         False                        0                       2      518               0
 483  []         []               False         False                        0                       2      519               0
 484  []         []               False         False                        0                       2      520               0
 485  []         []               False         False                        0                       2      521               0
 486  []         []               False         False                        0                       2      522               0
 487  []         []               False         False                        0                       2      523               0
 488  []         []               False         False                        0                       2      524               0
 489  []         []               False         False                        0                       2      525               0
 490  []         []               False         False                        0                       2      526               0
 491  []         []               False         False                        0                       2      527               0
 492  []         []               False         False                        0                       2      528               0
 493  []         []               False         False                        0                       2      529               0
 494  []         []               False         False                        0                       2      530               0
 495  []         []               False         False                        0                       2      531               0
 496  []         []               False         False                        0                       2      532               0
 497  []         []               False         False                        0                       2      533               0
 498  []         []               False         False                        0                       2      534               0
 499  []         []               False         False                        0                       2      535               0
 500  []         []               False         False                        0                       2      536               0
```

# Day 2

调查方向：vdbench 本身机制

```
[root@node70-86 22:36:40 ~]$dmidecode -t memory
# dmidecode 3.0
Getting SMBIOS data from sysfs.
SMBIOS 3.2.1 present.
# SMBIOS implementations newer than version 3.0 are not
# fully supported by this version of dmidecode.

Handle 0x001F, DMI type 16, 23 bytes
Physical Memory Array
        Location: System Board Or Motherboard
        Use: System Memory
        Error Correction Type: Single-bit ECC
        Maximum Capacity: 7680 GB
        Error Information Handle: Not Provided
        Number Of Devices: 24

Handle 0x0020, DMI type 17, 84 bytes
Memory Device
        Array Handle: 0x001F
        Error Information Handle: Not Provided
        Total Width: 72 bits
        Data Width: 64 bits
        Size: 16384 MB
        Form Factor: DIMM
        Set: None
        Locator: DIMM 5
        Bank Locator: CPU 1
        Type: DDR4
        Type Detail: Synchronous
        Speed: 3200 MHz
        Manufacturer: SK Hynix
        Serial Number: 85609CF9
        Asset Tag: Unknown
        Part Number: HMA82GR7DJR8N-XN
        Rank: 2
        Configured Clock Speed: 2666 MHz
        Minimum Voltage: 1.2 V
        Maximum Voltage: 1.2 V
        Configured Voltage: 1.2 V
```

```
# dmidecode 3.0
Getting SMBIOS data from sysfs.
SMBIOS 3.2.1 present.
# SMBIOS implementations newer than version 3.0 are not
# fully supported by this version of dmidecode.

Handle 0x001F, DMI type 16, 23 bytes
Physical Memory Array
        Location: System Board Or Motherboard
        Use: System Memory
        Error Correction Type: Single-bit ECC
        Maximum Capacity: 7680 GB
        Error Information Handle: Not Provided
        Number Of Devices: 24

Handle 0x0020, DMI type 17, 84 bytes
Memory Device
        Array Handle: 0x001F
        Error Information Handle: Not Provided
        Total Width: 72 bits
        Data Width: 64 bits
        Size: 16384 MB
        Form Factor: DIMM
        Set: None
        Locator: DIMM 5
        Bank Locator: CPU 1
        Type: DDR4
        Type Detail: Synchronous
        Speed: 3200 MHz
        Manufacturer: SK Hynix
        Serial Number: 00AD01213085609C87
        Asset Tag: Unknown
        Part Number: HMA82GR7DJR8N-XN
        Rank: 2
        Configured Clock Speed: 2666 MHz
        Minimum Voltage: 1.2 V
        Maximum Voltage: 1.2 V
        Configured Voltage: 1.2 V
```

```
# dmidecode 3.0
Getting SMBIOS data from sysfs.
SMBIOS 3.2.1 present.
# SMBIOS implementations newer than version 3.0 are not
# fully supported by this version of dmidecode.

Handle 0x001F, DMI type 16, 23 bytes
Physical Memory Array
        Location: System Board Or Motherboard
        Use: System Memory
        Error Correction Type: Single-bit ECC
        Maximum Capacity: 7680 GB
        Error Information Handle: Not Provided
        Number Of Devices: 24

Handle 0x0020, DMI type 17, 84 bytes
Memory Device
        Array Handle: 0x001F
        Error Information Handle: Not Provided
        Total Width: 72 bits
        Data Width: 64 bits
        Size: 16384 MB
        Form Factor: DIMM
        Set: None
        Locator: DIMM 5
        Bank Locator: CPU 1
        Type: DDR4
        Type Detail: Synchronous
        Speed: 3200 MHz
        Manufacturer: SK Hynix
        Serial Number: 85609D5B
        Asset Tag: Unknown
        Part Number: HMA82GR7DJR8N-XN
        Rank: 2
        Configured Clock Speed: 2666 MHz
        Minimum Voltage: 1.2 V
        Maximum Voltage: 1.2 V
        Configured Voltage: 1.2
```

三个节点都没有使用 ECC 内存。应该与 ECC 内存无关，因为都可以通过 memtest86 测试。
