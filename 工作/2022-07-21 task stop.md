```
(gdb) thread 6
[Switching to thread 6 (Thread 0x7f11ecf52700 (LWP 4259))]
#0  0x00007f11f2fbb1ad in nanosleep () from /lib64/libc.so.6
(gdb) bt
#0  0x00007f11f2fbb1ad in nanosleep () from /lib64/libc.so.6
#1  0x00007f11f2febec4 in usleep () from /lib64/libc.so.6
#2  0x000055b674e2bbac in zbs::consensus::QuorumServer::Stop (this=this@entry=0x55b677222000, ec=...) at src/consensus/quorum_server.cc:42
#3  0x000055b674de0c40 in zbs::task::TaskServer::BootRunner (this=0x55b677222000) at src/task/task_server.cc:193       <----- zk db 初始化失败，因此调用 stop，notify quorumcluster stop，并等待退出。
#4  0x000055b674e6d159 in run_and_reset (this=0x55b677712450) at src/common/coroutine.h:312
#5  zbs::Coroutine::LoopMain (this=0x55b677712340) at src/common/coroutine.cc:615
#6  0x000055b674e6d1e2 in zbs::Coroutine::s_co_main (lo=<optimized out>, hi=<optimized out>) at src/common/coroutine.cc:602
```

```
(gdb) thread 4
[Switching to thread 4 (Thread 0x7f11edf54700 (LWP 4176))]
#0  0x00007f11f68fe945 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
(gdb) bt
#0  0x00007f11f68fe945 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0
#1  0x00007f11f3888a6c in std::condition_variable::wait(std::unique_lock<std::mutex>&) () from /lib64/libstdc++.so.6
#2  0x000055b674ddf133 in wait<zbs::Sync::WaitAndReset()::<lambda()> > (__p=..., __lock=..., this=0x55b677733c10) at /opt/rh/devtoolset-7/root/usr/include/c++/7/condition_variable:99
#3  WaitAndReset (this=0x55b677733bd0) at src/common/closure.h:66
#4  zbs::task::TaskServer::StopRunner (this=this@entry=0x55b677222000) at src/task/task_server.cc:173     <------- 等待 stop runner 结束
#5  0x000055b674de171f in zbs::task::TaskServer::StopService (this=0x55b677222000) at src/task/task_server.cc:120
#6  0x000055b674e2c1d9 in zbs::consensus::QuorumServer::OnStatusChange (this=0x55b677222000, event=zbs::consensus::STOPPED) at src/consensus/quorum_server.cc:83
#7  0x000055b674e229fe in operator() (__args#0=<optimized out>, this=0x55b677222298) at /opt/rh/devtoolset-7/root/usr/include/c++/7/bits/std_function.h:706
#8  zbs::consensus::QuorumCluster::OnEvent (this=0x55b677222020, event=zbs::consensus::STOPPED) at src/consensus/quorum_cluster.cc:271
#9  0x000055b674e6d159 in run_and_reset (this=0x55b677712110) at src/common/coroutine.h:312
#10 zbs::Coroutine::LoopMain (this=0x55b677712000) at src/common/coroutine.cc:615
#11 0x000055b674e6d1e2 in zbs::Coroutine::s_co_main (lo=<optimized out>, hi=<optimized out>) at src/common/coroutine.cc:602
```

```bash
# 启动 quorum cluster
I0721 16:33:40.587217  3871 quorum_cluster.cc:99] Initializing quorum cluster.
I0721 16:33:40.587252  3871 quorum_cluster.cc:106] Watch priority_path: /zos/service/taskd_priority
I0721 16:33:40.587256  3871 quorum_cluster.cc:109] Done Initializing quorum cluster.

# 创建 zk client，创建连接
I0721 16:33:40.587260  3871 zookeeper.cc:146] Initialize zookeeper, zoo hosts: '10.0.20.61:2181,10.0.20.62:2181,10.0.20.63:2181', kSessiontimeout: 4000, client_id: 0x0, passwd: ''
I0721 16:33:40.587276  3871 main.cc:89] [ZOO] log_env:1104 2022-07-21 16:33:40,587:3871(0x7f11f6f52100):ZOO_INFO@log_env@1104: Client environment:zookeeper.version=zookeeper C client 3.5.9
I0721 16:33:40.587282  3871 main.cc:89] [ZOO] log_env:1108 2022-07-21 16:33:40,587:3871(0x7f11f6f52100):ZOO_INFO@log_env@1108: Client environment:host.name=node2063
I0721 16:33:40.587286  3871 main.cc:89] [ZOO] log_env:1115 2022-07-21 16:33:40,587:3871(0x7f11f6f52100):ZOO_INFO@log_env@1115: Client environment:os.name=Linux
I0721 16:33:40.587291  3871 main.cc:89] [ZOO] log_env:1116 2022-07-21 16:33:40,587:3871(0x7f11f6f52100):ZOO_INFO@log_env@1116: Client environment:os.arch=4.18.0-193.28.1.el7.smartx.3.x86_64
I0721 16:33:40.587294  3871 main.cc:89] [ZOO] log_env:1117 2022-07-21 16:33:40,587:3871(0x7f11f6f52100):ZOO_INFO@log_env@1117: Client environment:os.version=#1 SMP Thu May 13 10:33:47 UTC 2021
I0721 16:33:40.587568  3871 main.cc:89] [ZOO] log_env:1125 2022-07-21 16:33:40,587:3871(0x7f11f6f52100):ZOO_INFO@log_env@1125: Client environment:user.name=(null)
I0721 16:33:40.587582  3871 main.cc:89] [ZOO] log_env:1133 2022-07-21 16:33:40,587:3871(0x7f11f6f52100):ZOO_INFO@log_env@1133: Client environment:user.home=/root
I0721 16:33:40.587587  3871 main.cc:89] [ZOO] log_env:1145 2022-07-21 16:33:40,587:3871(0x7f11f6f52100):ZOO_INFO@log_env@1145: Client environment:user.dir=/
I0721 16:33:40.587592  3871 main.cc:89] [ZOO] zookeeper_init_internal:1188 2022-07-21 16:33:40,587:3871(0x7f11f6f52100):ZOO_INFO@zookeeper_init_internal@1188: Initiating client connection, host=10.0.20.61:2181,10.0.20.62:2181,10.0.20.63:2181 sessionTimeout=4000 watcher=0x55b674e2fce0 sessionId=0 sessionPasswd=<null> context=0x55b677222030 flags=0
I0721 16:33:40.793479  3871 zookeeper.cc:171] Initialize zookeeper done: client_id_: 0000000000000000 session_timeout: 4000 local session timeout_: 200
I0721 16:33:40.817111  4117 main.cc:89] [ZOO] check_events:2477 2022-07-21 16:33:40,817:3871(0x7f11eef56700):ZOO_INFO@check_events@2477: initiated connection to server [10.0.20.62:2181]
I0721 16:33:40.832994  4117 main.cc:89] [ZOO] check_events:2529 2022-07-21 16:33:40,832:3871(0x7f11eef56700):ZOO_INFO@check_events@2529: session establishment complete on server [10.0.20.62:2181], sessionId=0x2000006bbd60025, negotiated timeout=4000

I0721 16:33:40.837975  4176 thread.cc:114] Set thread name to: task-main
I0721 16:33:40.842954  4176 coroutine.cc:433] Adjust max cached coroutines for current thread,  old: 64 new:64 current:0

# zk 连接成功
W0721 16:33:40.845880  4176 zookeeper.cc:217] zookeeper session event: CONNECTING_STATE --> CONNECTED_STATE
W0721 16:33:40.874960  4176 zookeeper.cc:196] Stop the session timeout timer.
I0721 16:33:40.874992  4176 zookeeper.cc:228] zookeeper client_id: 0x2000006bbd60025, passwd: '6BA6571D34DD94763823B2F17C18050B'
I0721 16:33:40.875003  4176 quorum_cluster.cc:438] QuorumCluster state change: Initializing --> Connected

# 开始加入 cluster
I0721 16:33:40.879115  4176 quorum_cluster.cc:245] Try to join the cluster.
I0721 16:33:40.885936  4176 quorum_cluster.cc:625] Joined by creating path: /zos/service/taskd/z-0000000759 with value: 10.0.20.63:10601
I0721 16:33:40.889616  4176 quorum_cluster.cc:438] QuorumCluster state change: Connected --> Joined
I0721 16:33:40.896876  4176 quorum_cluster.cc:248] Join succeed.
I0721 16:33:41.366055  4176 quorum_cluster.cc:692] Ger priority config:
I0721 16:33:41.367188  4176 quorum_cluster.cc:523] Leader is 10.0.20.64:10601. seq is 756
I0721 16:33:41.370858  4176 quorum_cluster.cc:544] [MEMBER IDX]: 3
I0721 16:33:41.370882  4176 quorum_cluster.cc:438] QuorumCluster state change: Joined --> Running
I0721 16:33:41.370887  4176 quorum_cluster.cc:551] The quorum cluster status is changed to Running.
I0721 16:33:41.370903  4176 quorum_server.cc:71] Get quorum cluster event: ENTER_RUNNING
# 进入 running 状态

# 启动 task 服务
I0721 16:33:41.370908  4176 task_server.cc:94] Start the taskd service
I0721 16:33:41.371496  4258 thread.cc:114] Set thread name to: zbs-vip-server
I0721 16:33:41.371513  4258 coroutine.cc:433] Adjust max cached coroutines for current thread,  old: 64 new:64 current:0
I0721 16:33:41.371534  4258 task_db.cc:345] Initializing LocalVIPDb
I0721 16:33:41.374943  4259 thread.cc:114] Set thread name to: task-server-run
I0721 16:33:41.382817  4259 coroutine.cc:433] Adjust max cached coroutines for current thread,  old: 64 new:64 current:0

# 启动 runner
I0721 16:33:41.382854  4259 task_server.cc:183] Runner starts at 10.0.20.63:10601
I0721 16:33:41.559536  4259 task_db.cc:42] Creating zk task db
I0721 16:33:41.952029  4258 task_db.cc:350] Done initializing LocalVIPDb

# zk 断开连接
W0721 16:33:46.094007  4117 main.cc:84] [ZOO] zookeeper_interest:2288 2022-07-21 16:33:46,093:3871(0x7f11eef56700):ZOO_WARN@zookeeper_interest@2288: Exceeded deadline by 3394ms
E0721 16:33:46.165318  4117 main.cc:81] [ZOO] handle_socket_error_msg:2390 2022-07-21 16:33:46,165:3871(0x7f11eef56700):ZOO_ERROR@handle_socket_error_msg@2390: Socket [10.0.20.62:2181] zk retcode=-7, errno=110(Connection timed out): connection to 10.0.20.62:2181 timed out (exceeded timeout by 2061ms)
W0721 16:33:46.176007  4117 main.cc:84] [ZOO] zookeeper_interest:2288 2022-07-21 16:33:46,175:3871(0x7f11eef56700):ZOO_WARN@zookeeper_interest@2288: Exceeded deadline by 3476ms

# 因为断开 zk 连接，Create zk task db 失败，开始 stop quorumserver
I0721 16:33:46.176045  4259 quorum_server.cc:34] Quorum server begins stopping, this: 0x55b677222000
I0721 16:33:46.181856  4259 quorum_cluster.cc:438] QuorumCluster state change: Running --> Stopped
I0721 16:33:46.181865  4259 quorum_server.cc:41] Wait for quorum server to stop, this:0x55b677222000

# zk 恢复连接
I0721 16:33:46.226018  4117 main.cc:89] [ZOO] check_events:2477 2022-07-21 16:33:46,226:3871(0x7f11eef56700):ZOO_INFO@check_events@2477: initiated connection to server [10.0.20.61:2181]
I0721 16:33:46.226864  4117 main.cc:89] [ZOO] check_events:2529 2022-07-21 16:33:46,226:3871(0x7f11eef56700):ZOO_INFO@check_events@2529: session establishment complete on server [10.0.20.61:2181], sessionId=0x2000006bbd60025, negotiated timeout=4000

I0721 16:33:46.250857  4258 task_db.cc:345] Initializing LocalVIPDb # 第二次 LocalVIPDb::Initialize，所以直接返回 ok，没有 done 的日志
I0721 16:33:46.307961  4258 task_vip_service.cc:313] Clean VIP for service: iscsi vip: 172.0.20.241
I0721 16:33:46.318958  4258 task_vip_service.cc:313] Clean VIP for service: management vip: 192.168.20.241
I0721 16:33:46.319844  4176 task_server.cc:115] Done starting the taskd service # 其他 task 认为我是 leader，但因为我当前状态不是 running，所以我认为我不是 leader，没有初始化 dispatcher

I0721 16:33:46.321825  4176 quorum_server.cc:71] Get quorum cluster event: Members_Changed
I0721 16:33:46.321838  4176 quorum_server.cc:90] Members changed.

# 收到 stopped
I0721 16:33:46.321846  4176 quorum_server.cc:71] Get quorum cluster event: STOPPED
I0721 16:33:46.321849  4176 task_server.cc:165] Stop runner
# runner 析构，要 asyncserver shutdown

# 此时，由于之前的 task runner 正在进行 stop，notify 之后等待 stop 完成
# 然后，

# runner 没停下来。于是 task 维持在一个没有 leader 的状态。
I0721 16:33:47.183830  4259 quorum_server.cc:41] Wait for quorum server to stop, this:0x55b677222000
I0721 16:33:48.186841  4259 quorum_server.cc:41] Wait for quorum server to stop, this:0x55b677222000
I0721 16:33:49.188818  4259 quorum_server.cc:41] Wait for quorum server to stop, this:0x55b677222000
I0721 16:33:50.191824  4259 quorum_server.cc:41] Wait for quorum server to stop, this:0x55b677222000
I0721 16:33:51.193851  4259 quorum_server.cc:41] Wait for quorum server to stop, this:0x55b677222000
I0721 16:33:52.193972  4259 quorum_server.cc:41] Wait for quorum server to stop, this:0x55b677222000
```

# 为什么 runner 没停下来？

```
I0722 01:55:38.229719 62144 task_runner.cc:182] TaskRunner::~TaskRunner()
I0722 01:55:38.229734 62144 async_service.cc:78] AsyncServer::Shutdown()
I0722 01:55:38.229748 62144 async_service.cc:78] AsyncServer::Shutdown()
```

析构顺序：先类再成员，先子类再父类

rpc*server* 是 TaskRunner 的成员。TaskRunner 开始析构。

- 先析构 class。TaskRunner 析构调用 rpc*server*.Shutdown()
- 再析构成员。TaskRunnerRpcServer::~TaskRunnerRpcServer()
  - ...
  - 最后到 virtual ~AsyncServer() { Shutdown(); }

所以 AsyncServer::Shutdown() 被调用了两次。

```cpp
Status TaskRunner::Initialize() {
    rpc_server_.RegisterService(this);
    rpc_server_.Start();
    RETURN_IF_ERROR(zk_db_.Initialize());  // <-- 失败
    return Status::OK();
}
```

```cpp
void TaskServer::StartRunner() {
    runner_thctx_.reset(ThreadContext::RegisterNewThread("task-server-runner"));
    runner_thctx_->Sched(Coroutine::Create([=]() {
        BootRunner();
    }));
    runner_thctx_->Start();
}

void TaskServer::BootRunner() {
    SocketPtr server_socket =
            std::make_shared<TcpSocket>("0.0.0.0",
                                        FLAGS_taskd_runner_port);
    LOG(INFO) << "Runner starts at " << FLAGS_taskd_addr
              << ":" << FLAGS_taskd_runner_port;
    runner_.reset(new TaskRunner(server_socket, runner_thctx_->loop(), GetZk()));
    RegisterRunnerServices();

    FOREACH(TEST_runner_services_, it) {
        runner_->RegisterTaskService(*it);
    }

    Status st = runner_->Initialize();    <---- 失败
    if (!st.ok()) Stop(st);               <---- 进行 stop()

    if (!QuorumServer::IsLeader())
        running_ = true;
}

// 开始 stop
void QuorumServer::Stop(const Status& ec) {
    LOG(INFO) << "Quorum server begins stopping, this: " << this;
    CHECK(gettid() != thctx_->GetTid()) << "current tid: " << gettid() << " quorum tid: " << thctx_->GetTid();
    mutex_.Lock();
    exit_status_ = ec;
    mutex_.Unlock();
    quorum_cluster_.NotifyStop();    // 跟 cluster 说一声，然后开始玩手机
    while (!IsStopped()) {
        LOG(INFO) << "Wait for quorum server to stop, this:" << this;
        usleep(1'000'000);
    }
    LOG(INFO) << "Quorum server has stopped, this:" << this;
}

void QuorumCluster::NotifyStop() {
    LockGuard l(&mutex_);
    if (state_ == QuorumCluster::State::Stopped)
        return;
    SetState(QuorumCluster::State::Stopped);
    TriggerEvent(QuorumClusterEvent::STOPPED);    // 跟 server 说一声
}

void QuorumServer::OnStatusChange(QuorumClusterEvent event) {
    CoLockGuard l(&co_mutex_);
    LOG(INFO) << "Get quorum cluster event: "
              << QuorumClusterEventStr(event);

    switch (event) {
        case QuorumClusterEvent::ENTER_RUNNING:
            StartService();
            break;
        case QuorumClusterEvent::ROLE_CHANGED:
            LOG(WARNING) << "Role changed.";
            OnRoleChanged();
            break;
        case QuorumClusterEvent::STOPPED:
            StopService();                     // server 要停止啦
            break;
        case QuorumClusterEvent::EXPIRED:
            LOG(WARNING) << "Session expired.";
            OnSessionExpired();
            break;
        case QuorumClusterEvent::MEMBERS_CHANGED:
            LOG(INFO) << "Members changed.";
            OnMembersChanged();
            break;
        default:
            InthreadNotifyStop(EAgain);
            break;
    }
}

void TaskServer::StopService() {
    running_ = false;
    CHECK_STATUS(StopRunner());
    CHECK_STATUS(StopDispatcher());
    CHECK_STATUS(StopVIPServer());
}

Status TaskServer::StopRunner() {
    LOG(INFO) << "Stop runner";

    Sync sync;
    runner_thctx_->Sched(Coroutine::Create([=, &sync]() {    // 问题来了，runner loop 还在玩手机，所以这个 coroutine 还在队列里等着
        runner_.reset();
        sync.Run();
    }));

    sync.WaitAndReset();
    runner_thctx_->StopAndJoin();
    runner_thctx_.reset();
    return Status::OK();
}
```
