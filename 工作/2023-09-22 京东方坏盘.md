# 操作

```
2023-09-20 17:29:09 zgrep -r 'pid: 143114' /var/log/zbs/zbs-chunkd.log*
2023-09-20 19:03:49 zbs-meta pextent reset_ever_exist 143114
2023-09-20 19:03:57 zbs-meta pextent reset_ever_exist 143114 240736
2023-09-21 09:11:30 zbs-meta pextent reset_ever_exist 238253 419095

2023-09-20 19:30:03 zbs-chunk partition invalidate --scheme uuid fbbc2d4c-a9ec-46e0-993d-c7c1c23e6ffc
2023-09-21 10:07:29 zbs-chunk partition invalidate --scheme uuid 22fd39e2-a48e-4efd-bd9d-b36119386ea6
```

# 故障时间线

概要：节点 175 和节点 173 各损坏一块磁盘，两个 Extent 数据丢失（pid={143114, 238253}）。默认的两副本设置无法覆盖此情况，两个节点的硬件故障使得这两个 Extent 的所有副本丢失。

损坏硬盘：
173 节点上的：`/dev/sdf`
175 节点上的：`/dev/sdh`

影响范围：
虚拟机 `JIRA-test` 的虚拟卷 `JIRA-test-1` 的一个 Extent（256MiB）被重置
虚拟机 `vaas-dev-202212301037-1` 的虚拟卷 `02-bingops 模板-dev-dockerV1.1-2` 的其中一个 Extent（256MiB） 被重置

处置过程
首先尝试在 173 节点上拔插 /dev/sdf 磁盘，未能识别；一线同事将此磁盘插入到其他节点，也未能识别到分区。
请售后同事与客户进行沟通，确认影响。客户确认该虚拟机为测试虚拟机，数据可以重置，于是将 Extent（pid=143114）进行重置，重置后读取结果为 0。处置途中遭遇之前版本中由于不良的 Extent 引用关系导致的无法 recover 的问题，@wangsai 在 chunk 上进行 hot patch 解决了此问题，Extent（pid=143114）在数据重置后顺利恢复。
在该 Extent（pid=143114）恢复后，发现还存在一个 Extent（pid=238253）仍然无法恢复，并且在一段时间后由于副本离线，成为 dead extent。上线查看，原因仍然为硬件故障导致，经一线同事确认客户同意后，进行了副本的重置操作。之后并未发现更多的数据损失。

建议

- 建议升级到 SMTX OS 4.0.14 及其更高版本。更新的版本（4.0.13 及其更新版本）支持磁盘巡检功能，会定期对数据进行扫描，及时发现损坏的副本。
- 建议联系供应商检查并修复 175 硬件故障（如背板，硬盘，HBA 等）

日志
在 09-20 15:09:08 时，节点 173 上的 chunk 首次报告 /dev/sdf 存在 bdev slow 和无法进行 fdatasync 的问题。

```
W0920 15:09:08.335919 29441 block_device.cc:58] [BDEV SLOW] op: WRITE len: 262144 elapsed sec: 11 bdev: hw_id: "ata-ST8000NM012A-2KE131_WSD4Z268-part1" part_uuid: "67790b12-9e77-4389-9fac-5f4dcf9276fb" path: "/dev/sdf1" lsm_uuid: "5cb00e0f-beb7-4324-bc0d-1f56bc66966a" lsm_bdev_uuid: "fbbc2d4c-a9ec-46e0-993d-c7c1c23e6ffc" version: 2 layout { block_size: 262144 superblock_size: 4096 num_superblocks: 1 __deprecated_bulk_size: 4096 checksum_type: 0 checksum_unit: 8192 checksum_size: 512 first_group_offset: 1048576 num_groups: 1 group_size_on_disk: 8001560772608 } bdev_id: 4 type: SATA_HDD_PARTITION raw_size: 8001561821184 ctime: 1657871959 num_total_blocks: 28728030 num_slow_io: 1 status: BDEV_STATUS_MOUNTED

E0920 15:09:32.585312 29441 co_file_handle.cc:132] Call fdatasync fails fname: /dev/sdf1 fd: 89 errno: 5 errstr: Input/output error
```

175 节点 `/dev/sdh` 在 09-20 15:58:45 时出现 critical medium error，系硬件故障。
![](assets/企业微信截图_69bee162-33d4-4300-a0ae-c2e290a15ab2.png)
